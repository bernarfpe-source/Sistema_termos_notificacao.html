<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Termos de Notifica√ß√£o ‚Äî AGER / ANTT</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d0f14;--surface:#151820;--surface2:#1c2030;--border:#252a3a;--accent:#4f8ef7;--accent2:#7c5cfc;--green:#22c981;--yellow:#f5c842;--red:#f75c5c;--orange:#f7924f;--text:#e8eaf0;--muted:#6b7280;--muted2:#9ca3af;--font-head:'Syne',sans-serif;--font-body:'DM Sans',sans-serif;}
:root.light{--bg:#f0f2f7;--surface:#ffffff;--surface2:#f5f6fa;--border:#e2e5ef;--accent:#2563eb;--accent2:#7c3aed;--green:#16a34a;--yellow:#d97706;--red:#dc2626;--orange:#ea580c;--text:#111827;--muted:#9ca3af;--muted2:#6b7280;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;}
.sidebar{position:fixed;left:0;top:0;bottom:0;width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;}
.logo{padding:24px 20px 20px;border-bottom:1px solid var(--border);}
.logo-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,var(--accent),var(--accent2));padding:4px 10px;border-radius:20px;font-family:var(--font-head);font-size:10px;font-weight:700;letter-spacing:.1em;color:#fff;margin-bottom:8px;}
.logo h1{font-family:var(--font-head);font-size:15px;font-weight:700;line-height:1.3;}
.logo p{font-size:11px;color:var(--muted);margin-top:2px;}
.nav{padding:16px 12px;flex:1;}
.nav-section{font-size:10px;font-weight:600;letter-spacing:.12em;color:var(--muted);text-transform:uppercase;padding:4px 8px;margin-bottom:6px;margin-top:16px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--muted2);transition:all .15s;user-select:none;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:rgba(79,142,247,.12);color:var(--accent);font-weight:500;}
.nav-item svg{width:16px;height:16px;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px;}
.sidebar-footer{padding:16px;border-top:1px solid var(--border);font-size:11px;color:var(--muted);text-align:center;}
.main{margin-left:220px;min-height:100vh;display:flex;flex-direction:column;}
.topbar{height:58px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;padding:0 24px;position:sticky;top:0;z-index:50;}
.topbar h2{font-family:var(--font-head);font-size:16px;font-weight:700;flex:1;}
.search-wrap{position:relative;}
.search-wrap svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--muted);}
.search-input{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:7px 12px 7px 32px;color:var(--text);font-family:var(--font-body);font-size:13px;width:220px;outline:none;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--muted);}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;font-family:var(--font-body);font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .15s;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{opacity:.88;}
.btn-ghost{background:var(--surface2);color:var(--muted2);border:1px solid var(--border);}
.btn-ghost:hover{color:var(--text);border-color:var(--muted);}
.btn-danger{background:rgba(247,92,92,.12);color:var(--red);border:1px solid rgba(247,92,92,.3);}
.btn-danger:hover{background:rgba(247,92,92,.25);}
.btn-edit{background:rgba(79,142,247,.12);color:var(--accent);border:1px solid rgba(79,142,247,.3);}
.btn-edit:hover{background:rgba(79,142,247,.25);}
.theme-toggle{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:24px;padding:5px 12px 5px 6px;cursor:pointer;transition:all .2s;user-select:none;flex-shrink:0;}
.theme-toggle:hover{border-color:var(--accent);}
.toggle-track{width:34px;height:18px;background:var(--border);border-radius:9px;position:relative;transition:background .3s;flex-shrink:0;}
.light .toggle-track{background:var(--accent);}
.toggle-thumb{position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .3s cubic-bezier(.34,1.56,.64,1);box-shadow:0 1px 4px rgba(0,0,0,.3);}
.light .toggle-thumb{transform:translateX(16px);}
.toggle-icon{font-size:14px;line-height:1;}
.toggle-label{font-size:12px;color:var(--muted2);font-weight:500;}
.content{padding:24px;flex:1;}
.page{display:none;}
.page.active{display:block;}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.stat-card.blue::before{background:linear-gradient(90deg,var(--accent),var(--accent2));}
.stat-card.green::before{background:var(--green);}
.stat-card.yellow::before{background:var(--yellow);}
.stat-card.red::before{background:var(--red);}
.stat-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:600;margin-bottom:8px;}
.stat-value{font-family:var(--font-head);font-size:32px;font-weight:800;line-height:1;margin-bottom:6px;}
.stat-sub{font-size:12px;color:var(--muted2);}
.filters-bar{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap;}
.filter-select{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:7px 12px;color:var(--text);font-family:var(--font-body);font-size:13px;outline:none;cursor:pointer;}
.filter-select:focus{border-color:var(--accent);}
.filter-label{font-size:12px;color:var(--muted);font-weight:500;}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.table-head-row{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--surface2);}
.table-count{font-size:12px;color:var(--muted);}
table{width:100%;border-collapse:collapse;}
thead th{text-align:left;padding:10px 14px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);background:var(--surface2);border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:var(--surface2);}
tbody td{padding:11px 14px;font-size:13px;vertical-align:middle;}
.td-assunto{max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--muted2);font-size:12px;}
.tag{display:inline-block;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap;}
.tag-rn{background:rgba(79,142,247,.15);color:var(--accent);}
.tag-xv{background:rgba(124,92,252,.15);color:var(--accent2);}
.tag-ager{background:rgba(34,201,129,.15);color:var(--green);}
.tag-antt{background:rgba(245,200,66,.15);color:var(--yellow);}
.status-dot{display:inline-flex;align-items:center;gap:5px;font-size:12px;white-space:nowrap;}
.status-dot::before{content:'';width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.s-vencido{color:var(--red);}
.s-vencido::before{background:var(--red);box-shadow:0 0 6px var(--red);}
.s-urgente{color:var(--orange);}
.s-urgente::before{background:var(--orange);animation:pulse 1.5s infinite;}
.s-ok{color:var(--green);}
.s-ok::before{background:var(--green);}
.s-encerrado{color:var(--muted);}
.s-encerrado::before{background:var(--muted);}
.s-pendente{color:var(--muted2);}
.s-pendente::before{background:var(--muted2);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.prazo-vencido{color:var(--red);font-weight:600;}
.prazo-urgente{color:var(--orange);font-weight:600;}
.prazo-date{font-size:12px;color:var(--muted2);}
.row-actions{display:flex;gap:4px;opacity:0;transition:opacity .15s;}
tbody tr:hover .row-actions{opacity:1;}
.row-btn{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid var(--border);background:var(--surface);transition:all .15s;color:var(--muted2);}
.row-btn:hover{border-color:var(--accent);color:var(--accent);}
.row-btn.del:hover{border-color:var(--red);color:var(--red);}
.row-btn svg{width:13px;height:13px;}
.pagination{display:flex;align-items:center;gap:6px;justify-content:center;padding:14px;border-top:1px solid var(--border);}
.page-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;font-size:13px;transition:all .15s;background:var(--surface2);border:1px solid var(--border);color:var(--muted2);}
.page-btn:hover{color:var(--text);border-color:var(--muted);}
.page-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.page-btn.disabled{opacity:.3;pointer-events:none;}
.page-info{font-size:12px;color:var(--muted);margin:0 6px;}
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;}
.chart-title{font-family:var(--font-head);font-size:13px;font-weight:700;margin-bottom:16px;}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.bar-label{font-size:11px;color:var(--muted2);width:190px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;}
.bar-track{flex:1;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .6s cubic-bezier(.34,1.56,.64,1);}
.bar-val{font-size:11px;font-weight:700;color:var(--muted2);min-width:24px;text-align:right;}
.donut-wrap{display:flex;align-items:center;gap:20px;}
.donut-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:12px;color:var(--muted2);}
.donut-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.donut-item strong{color:var(--text);}
.alerts-list{display:flex;flex-direction:column;gap:10px;margin-bottom:24px;}
.alert-item{display:flex;align-items:center;gap:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 18px;cursor:pointer;transition:border-color .15s;}
.alert-item:hover{border-color:var(--muted);}
.alert-item.red{border-left:3px solid var(--red);}
.alert-item.orange{border-left:3px solid var(--orange);}
.alert-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.alert-icon.red{background:rgba(247,92,92,.15);color:var(--red);}
.alert-icon.orange{background:rgba(247,146,79,.15);color:var(--orange);}
.alert-icon svg{width:18px;height:18px;}
.alert-content{flex:1;}
.alert-title{font-size:13px;font-weight:500;margin-bottom:2px;}
.alert-sub{font-size:12px;color:var(--muted2);}
.alert-date{font-size:11px;color:var(--muted);white-space:nowrap;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:680px;max-height:88vh;overflow-y:auto;animation:mIn .2s ease;}
.modal-wide{width:740px;}
@keyframes mIn{from{opacity:0;transform:scale(.96) translateY(10px);}to{opacity:1;transform:none;}}
.modal-header{padding:22px 26px 18px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:14px;}
.modal-icon{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.modal-icon svg{width:22px;height:22px;color:#fff;}
.modal-header h3{font-family:var(--font-head);font-size:16px;font-weight:700;margin-bottom:4px;}
.modal-header p{font-size:12px;color:var(--muted2);}
.modal-close{margin-left:auto;cursor:pointer;color:var(--muted);padding:4px;}
.modal-close:hover{color:var(--text);}
.modal-close svg{width:20px;height:20px;}
.modal-body{padding:22px 26px;}
.modal-footer{padding:14px 26px;border-top:1px solid var(--border);display:flex;gap:8px;background:var(--surface2);border-radius:0 0 16px 16px;}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px;}
.detail-field label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);font-weight:600;margin-bottom:4px;}
.detail-field .val{font-size:13px;color:var(--text);}
.detail-field .val.mono{font-family:var(--font-head);font-weight:700;}
.desc-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-size:13px;color:var(--muted2);line-height:1.6;margin-top:4px;}
.status-select-wrap{display:flex;gap:8px;align-items:center;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
.status-select-wrap label{font-size:12px;color:var(--muted);font-weight:500;min-width:60px;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-field{display:flex;flex-direction:column;gap:5px;}
.form-field.full{grid-column:1/-1;}
.form-field label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:600;}
.form-field input,.form-field select,.form-field textarea{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:var(--font-body);font-size:13px;outline:none;transition:border-color .2s;width:100%;}
.form-field input:focus,.form-field select:focus,.form-field textarea:focus{border-color:var(--accent);}
.form-field input[type=text],.form-field textarea{text-transform:uppercase;}
.form-field textarea{resize:vertical;min-height:80px;}
.form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:22px;padding-top:18px;border-top:1px solid var(--border);}
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:400;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.confirm-overlay.open{display:flex;}
.confirm-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:32px;width:380px;text-align:center;animation:mIn .2s ease;}
.confirm-box .icon{font-size:42px;margin-bottom:14px;}
.confirm-box h4{font-family:var(--font-head);font-size:16px;margin-bottom:8px;}
.confirm-box p{font-size:13px;color:var(--muted2);margin-bottom:24px;line-height:1.5;}
.confirm-btns{display:flex;gap:10px;justify-content:center;}
.empty-state{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-state svg{width:48px;height:48px;margin:0 auto 12px;display:block;opacity:.3;}
.empty-state p{font-size:14px;}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}

/* UPLOAD AREAS */
.upload-section{margin-top:20px;padding-top:18px;border-top:1px solid var(--border);}
.upload-section-title{font-family:var(--font-head);font-size:13px;font-weight:700;margin-bottom:14px;color:var(--text);}
.upload-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.upload-box{border:2px dashed var(--border);border-radius:10px;padding:16px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:var(--surface2);}
.upload-box:hover{border-color:var(--accent);background:rgba(79,142,247,.05);}
.upload-box.has-image{border-style:solid;border-color:var(--green);}
.upload-box input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.upload-box-icon{font-size:24px;margin-bottom:6px;}
.upload-box-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:2px;}
.upload-box-sub{font-size:10px;color:var(--muted2);}
.upload-preview{width:100%;height:90px;object-fit:cover;border-radius:6px;margin-bottom:6px;display:block;}
.upload-remove{position:absolute;top:6px;right:6px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;cursor:pointer;z-index:2;opacity:0;transition:opacity .15s;}
.upload-box:hover .upload-remove{opacity:1;}
.upload-remove:hover{transform:scale(1.1);}

/* VALOR */
.valor-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(34,201,129,.12);color:var(--green);border:1px solid rgba(34,201,129,.3);border-radius:20px;padding:3px 10px;font-size:12px;font-weight:700;font-family:var(--font-head);}
.valor-input-wrap{position:relative;}
.valor-input-wrap::before{content:'R$';position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px;font-weight:600;pointer-events:none;}
.valor-input-wrap input{padding-left:32px !important;}

/* IMAGE VIEWER */
.img-viewer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.img-viewer-overlay.open{display:flex;}
.img-viewer-overlay img{max-width:90vw;max-height:90vh;border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,.5);}
.img-viewer-close{position:fixed;top:20px;right:24px;font-size:28px;color:#fff;cursor:pointer;opacity:.7;}
.img-viewer-close:hover{opacity:1;}
.img-thumb-row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;}
.img-thumb{width:80px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid var(--border);transition:border-color .15s;}
.img-thumb:hover{border-color:var(--accent);}
.img-thumb-label{font-size:10px;color:var(--muted);text-align:center;margin-top:3px;}
.img-thumb-wrap{display:flex;flex-direction:column;align-items:center;}

.tag-nc{background:rgba(34,201,129,.15);color:#22c981;}
.tag-tr{background:rgba(247,146,79,.15);color:#f7924f;}

/* REPORTS */
.report-filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:20px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 18px;}
.report-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;}
.report-card-title{font-family:var(--font-head);font-size:14px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.report-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
.report-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px;}
.rep-stat{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center;}
.rep-stat-val{font-family:var(--font-head);font-size:28px;font-weight:800;margin-bottom:4px;}
.rep-stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;}
.rep-table{width:100%;border-collapse:collapse;font-size:13px;}
.rep-table th{text-align:left;padding:8px 12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);border-bottom:1px solid var(--border);}
.rep-table td{padding:9px 12px;border-bottom:1px solid var(--border);}
.rep-table tr:last-child td{border-bottom:none;}
.rep-table tr:hover td{background:var(--surface2);}
.export-bar{display:flex;gap:8px;margin-bottom:16px;}
.btn-export-pdf{background:rgba(247,92,92,.12);color:var(--red);border:1px solid rgba(247,92,92,.3);}
.btn-export-pdf:hover{background:rgba(247,92,92,.22);}
.btn-export-xls{background:rgba(34,201,129,.12);color:var(--green);border:1px solid rgba(34,201,129,.3);}
.btn-export-xls:hover{background:rgba(34,201,129,.22);}
@media print{.sidebar,.topbar,.export-bar,.report-filters button,.nav-item{display:none!important;}.main{margin-left:0!important;}.modal-overlay{display:none!important;}}
</style>
</head>
<body>


<!-- LOGIN SCREEN -->
<div id="login-overlay" style="display:flex;position:fixed;inset:0;background:var(--bg);z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:40px 48px;width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.4);">
    <div style="display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,var(--accent),var(--accent2));padding:6px 14px;border-radius:20px;font-family:var(--font-head);font-size:11px;font-weight:700;letter-spacing:.1em;color:#fff;margin-bottom:20px;">‚öñ JUR√çDICO</div>
    <h2 style="font-family:var(--font-head);font-size:22px;font-weight:800;margin-bottom:4px;">Termos de Notifica√ß√£o</h2>
    <p style="font-size:13px;color:var(--muted2);margin-bottom:28px;">AGER &amp; ANTT ‚Äî Acesso Restrito</p>
    <div id="login-error" style="display:none;background:rgba(247,92,92,.12);border:1px solid rgba(247,92,92,.3);color:var(--red);border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:16px;">Usu√°rio ou senha incorretos.</div>
    <div style="display:flex;flex-direction:column;gap:12px;text-align:left;">
      <div>
        <label style="font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:600;display:block;margin-bottom:5px;">Usu√°rio</label>
        <input id="login-user" type="text" placeholder="Digite seu usu√°rio" autocomplete="username"
          style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:var(--font-body);font-size:14px;outline:none;transition:border-color .2s;"
          onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor=''"
          onkeydown="if(event.key==='Enter')document.getElementById('login-pass').focus()">
      </div>
      <div>
        <label style="font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:600;display:block;margin-bottom:5px;">Senha</label>
        <div style="position:relative;">
          <input id="login-pass" type="password" placeholder="Digite sua senha" autocomplete="current-password"
            style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 40px 10px 14px;color:var(--text);font-family:var(--font-body);font-size:14px;outline:none;transition:border-color .2s;"
            onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor=''"
            onkeydown="if(event.key==='Enter')doLogin()">
          <span onclick="togglePass()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--muted);font-size:16px;" id="pass-eye">üëÅ</span>
        </div>
      </div>
      <button onclick="doLogin()" style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:11px;font-family:var(--font-head);font-size:14px;font-weight:700;cursor:pointer;margin-top:4px;transition:opacity .15s;" onmouseover="this.style.opacity='.88'" onmouseout="this.style.opacity='1'">
        ENTRAR
      </button>
    </div>
    <p style="font-size:11px;color:var(--muted);margin-top:20px;">Acesso somente para colaboradores autorizados</p>
  </div>
</div>

<nav class="sidebar">
  <div class="logo">
    <div class="logo-badge">‚öñ JUR√çDICO</div>
    <h1>Termos de<br>Notifica√ß√£o</h1>
    <p>AGER &amp; ANTT</p>
  </div>
  <nav class="nav">
    <div class="nav-section">Menu</div>
    <div class="nav-item active" onclick="showPage('dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>Dashboard
    </div>
    <div class="nav-item" onclick="showPage('lista')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>Processos
      <span class="nav-badge" id="badge-vencidos">0</span>
    </div>
    <div class="nav-item" onclick="showPage('alertas')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg>Alertas
      <span class="nav-badge" id="badge-alertas">0</span>
    </div>
    <div class="nav-item" onclick="showPage('novo')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Novo Termo
    </div>
    <div class="nav-item" onclick="abrirMinhaSenha()" style="margin-top:4px">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>Minha Senha
    </div>
    <div class="nav-section" style="margin-top:8px">Relat√≥rios</div>
    <div class="nav-item" onclick="showPage('relatorios')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>Relat√≥rios
    </div>
    <div id="nav-admin" style="display:none">
      <div class="nav-section">Administra√ß√£o</div>
      <div class="nav-item" onclick="showPage('usuarios')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>Usu√°rios
      </div>
    </div>
  </nav>
  <div class="sidebar-footer" style="display:flex;flex-direction:column;gap:8px;"><span>v2025 ¬∑ Setor Jur√≠dico</span><span id="logged-user" style="color:var(--accent);font-weight:600;font-size:12px;"></span><button onclick="doLogout()" style="background:rgba(247,92,92,.1);border:1px solid rgba(247,92,92,.3);color:var(--red);border-radius:6px;padding:5px 10px;font-size:11px;cursor:pointer;font-family:var(--font-body);">Sair</button></div>
</nav>

<main class="main">
  <div class="topbar">
    <h2 id="page-title">Dashboard</h2>
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      <input class="search-input" type="text" placeholder="Buscar processo, placa..." id="search-input" oninput="onSearch(this.value)">
    </div>
    <div class="theme-toggle" onclick="toggleTheme()">
      <div class="toggle-track"><div class="toggle-thumb"></div></div>
      <span class="toggle-icon" id="theme-icon">üåô</span>
      <span class="toggle-label" id="theme-label">Noturno</span>
    </div>
    <button class="btn btn-primary" onclick="showPage('novo')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Novo
    </button>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid" id="stats-grid"></div>
      <div class="chart-grid">
        <div class="chart-card"><div class="chart-title">Top Infra√ß√µes por Assunto</div><div id="chart-assuntos"></div></div>
        <div class="chart-card"><div class="chart-title">Por Empresa &amp; √ìrg√£o</div><div class="donut-wrap"><canvas id="canvas-orgao" width="120" height="120"></canvas><div id="legend-orgao"></div></div></div>
        <div class="chart-card"><div class="chart-title">Evolu√ß√£o Anual</div><div id="chart-anos"></div></div>
        <div class="chart-card"><div class="chart-title">Situa√ß√£o dos Prazos</div><div id="chart-status"></div></div>
      </div>
    </div>

    <!-- LISTA -->
    <div class="page" id="page-lista">
      <div class="filters-bar">
        <span class="filter-label">Empresa:</span>
        <select class="filter-select" id="f-empresa" onchange="applyFilters()"><option value="">Todas</option><option>Rio Novo</option><option>Xavante</option><option>Novo Caminho</option><option>Tarum√£</option></select>
        <span class="filter-label">√ìrg√£o:</span>
        <select class="filter-select" id="f-orgao" onchange="applyFilters()"><option value="">Todos</option><option>AGER</option><option>ANTT</option></select>
        <span class="filter-label">Ano:</span>
        <select class="filter-select" id="f-ano" onchange="applyFilters()"><option value="">Todos</option><option>2026</option><option>2025</option><option>2024</option><option>2023</option><option>2022</option></select>
        <span class="filter-label">Tipo:</span>
        <select class="filter-select" id="f-tipo" onchange="applyFilters()"><option value="">Todos</option><option>NOTIFICA√á√ÉO</option><option>RECURSO</option><option>IMPUGNA√á√ÉO</option><option>NOTIFICA√á√ÉO REGULAT√ìRIA</option><option>AUTUA√á√ÉO</option></select>
        <button class="btn btn-ghost" onclick="clearFilters()">Limpar</button>
      </div>
      <div class="table-wrap">
        <div class="table-head-row"><span class="table-count" id="table-count"></span></div>
        <table>
          <thead><tr>
            <th>N¬∫</th><th>Empresa</th><th>√ìrg√£o</th><th>Tipo</th>
            <th>Assunto</th><th>Local</th><th>Placa</th><th>Prazo</th><th>Status</th><th>Valor</th><th>A√ß√µes</th>
          </tr></thead>
          <tbody id="table-body"></tbody>
        </table>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>

    <!-- ALERTAS -->
    <div class="page" id="page-alertas">
      <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:24px;">
        <div class="stat-card red"><div class="stat-label">‚ö† Prazos Vencidos</div><div class="stat-value" id="alerta-vencidos" style="color:var(--red)">0</div><div class="stat-sub">Aten√ß√£o imediata</div></div>
        <div class="stat-card yellow"><div class="stat-label">üîî Vencendo em 7 dias</div><div class="stat-value" id="alerta-urgentes" style="color:var(--yellow)">0</div><div class="stat-sub">A√ß√£o necess√°ria</div></div>
        <div class="stat-card green"><div class="stat-label">‚úÖ Prazo OK</div><div class="stat-value" id="alerta-ok" style="color:var(--green)">0</div><div class="stat-sub">Dentro do prazo</div></div>
      </div>
      <div class="alerts-list" id="alerts-list"></div>
    </div>

    <!-- NOVO -->
    <div class="page" id="page-novo">
      <div style="max-width:700px;">
        <div style="margin-bottom:20px;"><h3 style="font-family:var(--font-head);font-size:18px;font-weight:700;margin-bottom:6px;">Cadastrar Novo Termo</h3><p style="color:var(--muted2);font-size:13px;">Campos com * s√£o obrigat√≥rios.</p></div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:26px;">
          <div class="form-grid">
            <div class="form-field"><label>Empresa *</label><select id="n-empresa"><option value="">Selecione</option><option>Rio Novo</option><option>Xavante</option><option>Novo Caminho</option><option>Tarum√£</option></select></div>
            <div class="form-field"><label>√ìrg√£o *</label><select id="n-orgao"><option value="">Selecione</option><option>AGER</option><option>ANTT</option></select></div>
            <div class="form-field"><label>Tipo *</label><select id="n-tipo"><option value="">Selecione</option><option>NOTIFICA√á√ÉO</option><option>RECURSO</option><option>IMPUGNA√á√ÉO</option><option>NOTIFICA√á√ÉO REGULAT√ìRIA</option><option>AUTUA√á√ÉO</option></select></div>
            <div class="form-field"><label>N¬∫ do Termo</label><input type="text" id="n-numero" placeholder="Ex: TN-0001/2025"></div>
            <div class="form-field"><label>Data de Entrada *</label><input type="date" id="n-data"></div>
            <div class="form-field"><label>Prazo Final</label><input type="date" id="n-prazo"></div>
            <div class="form-field full"><label>Assunto *</label><input type="text" id="n-assunto" placeholder="Ex: Atraso no hor√°rio de partida"></div>
            <div class="form-field"><label>Setor</label><select id="n-setor"><option value="">Selecione</option><option>OPERACIONAL</option><option>COMERCIAL</option><option>COMERCIAL/OPERACIONAL</option><option>OPERACIONAL/COMERCIAL</option><option>TECNOLOGIA DE INFORMA√á√ÉO</option><option>ADMINISTRATIVO</option></select></div>
            <div class="form-field"><label>Local da Autua√ß√£o</label><select id="n-local"><option value="">Selecione</option><option>GOI√ÇNIA/GO</option><option>BARRA DO GAR√áAS/MT</option><option>RIBEIR√ÉO CASCALHEIRA/MT</option><option>VILA RICA/MT</option><option>CUIAB√Å/MT</option><option>SINOP/MT</option><option>IMPERATRIZ/MA</option></select></div>
            <div class="form-field"><label>Prefixo</label><input type="text" id="n-prefixo"></div>
            <div class="form-field"><label>Placa</label><input type="text" id="n-placa"></div>
            <div class="form-field full"><label>Descri√ß√£o / Hist√≥rico</label><textarea id="n-descricao" placeholder="Descreva os fatos..."></textarea></div>
            <div class="form-field"><label>Status</label><select id="n-status"><option>PENDENTE</option><option>EM AN√ÅLISE</option><option>RESPONDIDA</option><option>PROTOCOLADO</option><option>ENCERRADO</option></select></div>
            <div class="form-field"><label>Observa√ß√µes</label><input type="text" id="n-obs" placeholder="Informa√ß√µes adicionais"></div>
            <div class="form-field"><label>üí∞ Valor da Autua√ß√£o (R$)</label><div class="valor-input-wrap"><input type="number" id="n-valor" placeholder="0,00" step="0.01" min="0"></div></div>
          </div>
          <!-- UPLOADS NOVO -->
          <div class="upload-section">
            <div class="upload-section-title">üìé Documentos do Processo</div>
            <div class="upload-grid">
              <div class="upload-box" id="n-box-autua" onclick="setActiveUpload('n','autua')" title="Clique, arraste ou cole com Ctrl+V">
                <input type="file" accept="image/*,application/pdf" onchange="handleUpload(this,'n','autua')">
                <div class="upload-box-icon">üìÑ</div>
                <div class="upload-box-label">Autua√ß√£o</div>
                <div class="upload-box-sub">Clique, arraste ou Ctrl+V</div>
              </div>
              <div class="upload-box" id="n-box-defesa" onclick="setActiveUpload('n','defesa')" title="Clique, arraste ou cole com Ctrl+V">
                <input type="file" accept="image/*,application/pdf" onchange="handleUpload(this,'n','defesa')">
                <div class="upload-box-icon">üõ°Ô∏è</div>
                <div class="upload-box-label">Defesa</div>
                <div class="upload-box-sub">Clique, arraste ou Ctrl+V</div>
              </div>
              <div class="upload-box" id="n-box-decisao" onclick="setActiveUpload('n','decisao')" title="Clique, arraste ou cole com Ctrl+V">
                <input type="file" accept="image/*,application/pdf" onchange="handleUpload(this,'n','decisao')">
                <div class="upload-box-icon">‚öñÔ∏è</div>
                <div class="upload-box-label">Decis√£o</div>
                <div class="upload-box-sub">Clique, arraste ou Ctrl+V</div>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn btn-ghost" onclick="showPage('lista')">Cancelar</button>
            <button class="btn btn-primary" onclick="salvarNovo()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              Salvar Processo
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- USUARIOS -->
    <div class="page" id="page-usuarios">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div>
          <h3 style="font-family:var(--font-head);font-size:18px;font-weight:700;margin-bottom:4px;">Gerenciar Usu√°rios</h3>
          <p style="color:var(--muted2);font-size:13px;">Crie, edite ou exclua usu√°rios do sistema.</p>
        </div>
        <button class="btn btn-primary" onclick="abrirNovoUser()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Novo Usu√°rio
        </button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Login</th><th>Nome</th><th>Perfil</th><th>A√ß√µes</th></tr></thead>
          <tbody id="users-tbody"></tbody>
        </table>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 18px;margin-top:16px;display:flex;align-items:center;gap:12px;">
        <span style="font-size:24px;">üîê</span>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:600;margin-bottom:2px;">Admin ‚Äî usu√°rio fixo do sistema</div>
          <div style="font-size:12px;color:var(--muted2);">Login: <strong>ADMIN</strong> ¬∑ A senha n√£o √© exibida por seguran√ßa.</div>
        </div>
        <button class="btn btn-edit" style="flex-shrink:0" onclick="abrirAlterarSenhaAdmin()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
          Alterar Senha
        </button>
      </div>

    <!-- RELATORIOS -->
    <div class="page" id="page-relatorios">

      <div class="report-filters">
        <span class="filter-label">Empresa:</span>
        <select class="filter-select" id="r-empresa" onchange="renderRelatorios()">
          <option value="">Todas</option>
          <option>Rio Novo</option><option>Xavante</option><option>Novo Caminho</option><option>Tarum√£</option>
        </select>
        <span class="filter-label">√ìrg√£o:</span>
        <select class="filter-select" id="r-orgao" onchange="renderRelatorios()">
          <option value="">Todos</option><option>AGER</option><option>ANTT</option>
        </select>
        <span class="filter-label">Ano:</span>
        <select class="filter-select" id="r-ano" onchange="renderRelatorios()">
          <option value="">Todos</option>
          <option>2026</option><option>2025</option><option>2024</option><option>2023</option><option>2022</option>
        </select>
        <span class="filter-label">Per√≠odo:</span>
        <input type="date" class="filter-select" id="r-de" onchange="renderRelatorios()" style="width:140px">
        <span class="filter-label">at√©</span>
        <input type="date" class="filter-select" id="r-ate" onchange="renderRelatorios()" style="width:140px">
        <button class="btn btn-ghost" onclick="limparFiltrosRel()">Limpar</button>
        <div class="export-bar" style="margin:0;margin-left:auto">
          <button class="btn btn-export-pdf" onclick="exportarPDF()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>PDF
          </button>
          <button class="btn btn-export-xls" onclick="exportarCSV()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>CSV
          </button>
        </div>
      </div>

      <!-- Resumo geral -->
      <div class="report-card" id="rep-resumo"></div>

      <!-- Por empresa -->
      <div class="report-grid">
        <div class="report-card" id="rep-empresa"></div>
        <div class="report-card" id="rep-orgao"></div>
      </div>

      <!-- Por status e localidade -->
      <div class="report-grid">
        <div class="report-card" id="rep-status"></div>
        <div class="report-card" id="rep-local"></div>
      </div>

      <!-- Multas por empresa -->
      <div class="report-card" id="rep-multas"></div>

      <!-- Evolu√ß√£o mensal -->
      <div class="report-card" id="rep-mensal"></div>

    </div>

    </div>

  </div>
</main>

<!-- MODAL: DETALHES -->
<div class="modal-overlay" id="modal-detail-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg></div>
      <div><h3 id="det-title">Detalhe</h3><p id="det-sub"></p></div>
      <div class="modal-close" onclick="document.getElementById('modal-detail-overlay').classList.remove('open')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
    </div>
    <div class="modal-body" id="det-body"></div>
    <div class="modal-footer">
      <button class="btn btn-danger" id="det-btn-excluir">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>Excluir
      </button>
      <button class="btn btn-edit" id="det-btn-editar" style="margin-left:auto">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Editar
      </button>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR -->
<div class="modal-overlay" id="modal-edit-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal modal-wide">
    <div class="modal-header">
      <div class="modal-icon" style="background:linear-gradient(135deg,var(--accent2),var(--accent))"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
      <div><h3>Editar Processo</h3><p id="edit-sub"></p></div>
      <div class="modal-close" onclick="document.getElementById('modal-edit-overlay').classList.remove('open')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="e-id">
      <div class="form-grid">
        <div class="form-field"><label>Empresa *</label><select id="e-empresa"><option value="">Selecione</option><option>Rio Novo</option><option>Xavante</option><option>Novo Caminho</option><option>Tarum√£</option><option>Novo Caminho</option><option>Tarum√£</option></select></div>
        <div class="form-field"><label>√ìrg√£o *</label><select id="e-orgao"><option value="">Selecione</option><option>AGER</option><option>ANTT</option></select></div>
        <div class="form-field"><label>Tipo *</label><select id="e-tipo"><option value="">Selecione</option><option>NOTIFICA√á√ÉO</option><option>RECURSO</option><option>IMPUGNA√á√ÉO</option><option>NOTIFICA√á√ÉO REGULAT√ìRIA</option><option>AUTUA√á√ÉO</option></select></div>
        <div class="form-field"><label>N¬∫ do Termo</label><input type="text" id="e-numero"></div>
        <div class="form-field"><label>Data de Entrada *</label><input type="date" id="e-data"></div>
        <div class="form-field"><label>Prazo Final</label><input type="date" id="e-prazo"></div>
        <div class="form-field full"><label>Assunto *</label><input type="text" id="e-assunto"></div>
        <div class="form-field"><label>Setor</label><select id="e-setor"><option value="">Selecione</option><option>OPERACIONAL</option><option>COMERCIAL</option><option>COMERCIAL/OPERACIONAL</option><option>OPERACIONAL/COMERCIAL</option><option>TECNOLOGIA DE INFORMA√á√ÉO</option><option>ADMINISTRATIVO</option></select></div>
        <div class="form-field"><label>Local da Autua√ß√£o</label><select id="e-local"><option value="">Selecione</option><option>GOI√ÇNIA/GO</option><option>BARRA DO GAR√áAS/MT</option><option>RIBEIR√ÉO CASCALHEIRA/MT</option><option>VILA RICA/MT</option><option>CUIAB√Å/MT</option><option>SINOP/MT</option><option>IMPERATRIZ/MA</option></select></div>
        <div class="form-field"><label>Prefixo</label><input type="text" id="e-prefixo"></div>
        <div class="form-field"><label>Placa</label><input type="text" id="e-placa"></div>
        <div class="form-field full"><label>Descri√ß√£o / Hist√≥rico</label><textarea id="e-descricao"></textarea></div>
        <div class="form-field"><label>Status</label><select id="e-status"><option>PENDENTE</option><option>EM AN√ÅLISE</option><option>RESPONDIDA</option><option>PROTOCOLADO</option><option>ENCERRADO</option></select></div>
        <div class="form-field"><label>Observa√ß√µes</label><input type="text" id="e-obs"></div>
        <div class="form-field"><label>üí∞ Valor da Autua√ß√£o (R$)</label><div class="valor-input-wrap"><input type="number" id="e-valor" placeholder="0,00" step="0.01" min="0"></div></div>
      </div>
      <!-- UPLOADS EDIT -->
      <div class="upload-section">
        <div class="upload-section-title">üìé Documentos do Processo</div>
        <div class="upload-grid">
          <div class="upload-box" id="e-box-autua" onclick="setActiveUpload('e','autua')" title="Clique, arraste ou cole com Ctrl+V">
            <input type="file" accept="image/*,application/pdf" onchange="handleUpload(this,'e','autua')">
            <div class="upload-box-icon">üìÑ</div>
            <div class="upload-box-label">Autua√ß√£o</div>
            <div class="upload-box-sub">Clique, arraste ou Ctrl+V</div>
          </div>
          <div class="upload-box" id="e-box-defesa" onclick="setActiveUpload('e','defesa')" title="Clique, arraste ou cole com Ctrl+V">
            <input type="file" accept="image/*,application/pdf" onchange="handleUpload(this,'e','defesa')">
            <div class="upload-box-icon">üõ°Ô∏è</div>
            <div class="upload-box-label">Defesa</div>
            <div class="upload-box-sub">Clique, arraste ou Ctrl+V</div>
          </div>
          <div class="upload-box" id="e-box-decisao" onclick="setActiveUpload('e','decisao')" title="Clique, arraste ou cole com Ctrl+V">
            <input type="file" accept="image/*,application/pdf" onchange="handleUpload(this,'e','decisao')">
            <div class="upload-box-icon">‚öñÔ∏è</div>
            <div class="upload-box-label">Decis√£o</div>
            <div class="upload-box-sub">Clique, arraste ou Ctrl+V</div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="document.getElementById('modal-edit-overlay').classList.remove('open')">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarEdicao()" style="margin-left:auto">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>Salvar Altera√ß√µes
      </button>
    </div>
  </div>
</div>

<!-- MODAL: NOVO/EDIT USUARIO -->
<div class="modal-overlay" id="user-modal-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal" style="width:480px">
    <div class="modal-header">
      <div class="modal-icon" style="background:linear-gradient(135deg,#22c981,#4f8ef7)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div><h3 id="user-modal-title">Novo Usu√°rio</h3><p>Preencha os dados de acesso</p></div>
      <div class="modal-close" onclick="document.getElementById('user-modal-overlay').classList.remove('open')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="u-idx">
      <div class="form-grid">
        <div class="form-field"><label>Login (Usu√°rio) *</label><input type="text" id="u-user" placeholder="Ex: JOAO" style="text-transform:uppercase"></div>
        <div class="form-field"><label>Nome Completo *</label><input type="text" id="u-nome" placeholder="Ex: JO√ÉO SILVA"></div>
        <div class="form-field"><label>Perfil</label>
          <select id="u-role">
            <option value="user">Usu√°rio</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <div class="form-field" id="u-pass-row">
          <label>Senha * <span style="font-size:10px;color:var(--muted)">(deixe em branco para manter)</span></label>
          <div style="position:relative">
            <input type="password" id="u-pass" placeholder="Nova senha" style="text-transform:none!important">
            <span onclick="togglePassById('u-pass','u-pass-eye')" id="u-pass-eye" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--muted)">üëÅ</span>
          </div>
        </div>
        <div class="form-field full">
          <label>Confirmar Senha *</label>
          <div style="position:relative">
            <input type="password" id="u-pass2" placeholder="Repita a senha" style="text-transform:none!important">
            <span onclick="togglePassById('u-pass2','u-pass2-eye')" id="u-pass2-eye" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--muted)">üëÅ</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="document.getElementById('user-modal-overlay').classList.remove('open')">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarUser()" style="margin-left:auto">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>Salvar
      </button>
    </div>
  </div>
</div>

<!-- MODAL: MINHA SENHA -->
<div class="modal-overlay" id="minha-senha-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal" style="width:420px">
    <div class="modal-header">
      <div class="modal-icon" style="background:linear-gradient(135deg,var(--orange),var(--red))">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      </div>
      <div><h3>Alterar Minha Senha</h3><p>Defina uma nova senha de acesso</p></div>
      <div class="modal-close" onclick="document.getElementById('minha-senha-overlay').classList.remove('open')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </div>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-field full">
          <label>Nova Senha *</label>
          <div style="position:relative">
            <input type="password" id="my-pass" placeholder="M√≠nimo 4 caracteres" style="text-transform:none!important">
            <span onclick="togglePassById('my-pass','my-pass-eye')" id="my-pass-eye" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--muted)">üëÅ</span>
          </div>
        </div>
        <div class="form-field full">
          <label>Confirmar Nova Senha *</label>
          <div style="position:relative">
            <input type="password" id="my-pass2" placeholder="Repita a senha" style="text-transform:none!important">
            <span onclick="togglePassById('my-pass2','my-pass2-eye')" id="my-pass2-eye" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--muted)">üëÅ</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="document.getElementById('minha-senha-overlay').classList.remove('open')">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarMinhaSenha()" style="margin-left:auto">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/></svg>Salvar Senha
      </button>
    </div>
  </div>
</div>

<!-- CONFIRM: EXCLUIR -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <div class="icon">üóëÔ∏è</div>
    <h4>Confirmar exclus√£o?</h4>
    <p id="confirm-text">Esta a√ß√£o n√£o pode ser desfeita.</p>
    <div class="confirm-btns">
      <button class="btn btn-ghost" onclick="document.getElementById('confirm-overlay').classList.remove('open')">Cancelar</button>
      <button class="btn btn-danger" id="confirm-btn">Excluir</button>
    </div>
  </div>
</div>


<!-- IMAGE VIEWER -->
<div class="img-viewer-overlay" id="img-viewer" onclick="document.getElementById('img-viewer').classList.remove('open')">
  <div class="img-viewer-close" onclick="document.getElementById('img-viewer').classList.remove('open')">‚úï</div>
  <img id="img-viewer-src" src="" alt="">
</div>

<script>
// ===== USERS & AUTH =====
const ADMIN_CRED = { user: 'ADMIN', pass: localStorage.getItem('tn_admin_pass') || 'admin123', nome: 'Administrador', role: 'admin' };

function loadUsers() {
  try {
    const s = localStorage.getItem('tn_users');
    return s ? JSON.parse(s) : [];
  } catch(e) { return []; }
}

function saveUsers(users) {
  try { localStorage.setItem('tn_users', JSON.stringify(users)); } catch(e) {}
}

function getAllUsers() {
  return [ADMIN_CRED, ...loadUsers()];
}

let currentUser = null;

function doLogin() {
  const u = document.getElementById('login-user').value.toUpperCase().trim();
  const p = document.getElementById('login-pass').value.trim();
  const found = getAllUsers().find(x => x.user === u && x.pass === p);
  if (!found) {
    document.getElementById('login-error').style.display = 'block';
    document.getElementById('login-pass').value = '';
    document.getElementById('login-user').focus();
    return;
  }
  currentUser = found;
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('login-overlay').style.display = 'none';
  document.getElementById('logged-user').textContent = 'üë§ ' + found.nome;
  sessionStorage.setItem('tn_logged', JSON.stringify({user: found.user, nome: found.nome, role: found.role||'user'}));
  // Show admin nav if admin
  const adminNav = document.getElementById('nav-admin');
  if (adminNav) adminNav.style.display = found.role === 'admin' ? 'block' : 'none';
}

function doLogout() {
  currentUser = null;
  sessionStorage.removeItem('tn_logged');
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-overlay').style.display = 'flex';
  document.getElementById('logged-user').textContent = '';
  const adminNav = document.getElementById('nav-admin');
  if (adminNav) adminNav.style.display = 'none';
}

function togglePass() {
  const inp = document.getElementById('login-pass');
  const eye = document.getElementById('pass-eye');
  if (inp.type === 'password') { inp.type = 'text'; eye.textContent = 'üôà'; }
  else { inp.type = 'password'; eye.textContent = 'üëÅ'; }
}

function togglePassById(inpId, eyeId) {
  const inp = document.getElementById(inpId);
  const eye = document.getElementById(eyeId);
  if (!inp || !eye) return;
  if (inp.type === 'password') { inp.type = 'text'; eye.textContent = 'üôà'; }
  else { inp.type = 'password'; eye.textContent = 'üëÅ'; }
}

// Check if already logged in this session
(function checkSession() {
  const s = sessionStorage.getItem('tn_logged');
  if (s) {
    try {
      const d = JSON.parse(s);
      currentUser = getAllUsers().find(x => x.user === d.user) || null;
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('logged-user').textContent = 'üë§ ' + d.nome;
      const adminNav = document.getElementById('nav-admin');
      if (adminNav) adminNav.style.display = d.role === 'admin' ? 'block' : 'none';
    } catch(e) {}
  }
})();

// ===== USER MANAGEMENT =====
function showUsuarios() {
  showPage('usuarios');
}

function renderUsuarios() {
  const users = loadUsers();
  const tbody = document.getElementById('users-tbody');
  if (!users.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:30px;color:var(--muted)">Nenhum usu√°rio cadastrado al√©m do Admin.</td></tr>`;
    return;
  }
  tbody.innerHTML = users.map((u, i) => `
    <tr>
      <td style="font-family:var(--font-head);font-weight:700">${u.user}</td>
      <td>${u.nome}</td>
      <td><span class="tag tag-ager">${u.role === 'admin' ? 'Admin' : 'Usu√°rio'}</span></td>
      <td style="display:flex;gap:6px;">
        <button class="btn btn-edit" style="padding:5px 10px;font-size:12px" onclick="abrirEditUser(${i})">‚úèÔ∏è Editar</button>
        <button class="btn btn-danger" style="padding:5px 10px;font-size:12px" onclick="excluirUser(${i})">üóëÔ∏è Excluir</button>
      </td>
    </tr>`).join('');
}

function abrirNovoUser() {
  document.getElementById('user-modal-title').textContent = 'Novo Usu√°rio';
  document.getElementById('u-idx').value = '-1';
  document.getElementById('u-user').value = '';
  document.getElementById('u-nome').value = '';
  document.getElementById('u-pass').value = '';
  document.getElementById('u-pass2').value = '';
  document.getElementById('u-role').value = 'user';
  document.getElementById('u-pass-row').style.display = '';
  document.getElementById('user-modal-overlay').classList.add('open');
}

function abrirEditUser(i) {
  const users = loadUsers();
  const u = users[i];
  if (!u) return;
  document.getElementById('user-modal-title').textContent = 'Editar Usu√°rio';
  document.getElementById('u-idx').value = i;
  document.getElementById('u-user').value = u.user;
  document.getElementById('u-nome').value = u.nome;
  document.getElementById('u-pass').value = '';
  document.getElementById('u-pass2').value = '';
  document.getElementById('u-role').value = u.role || 'user';
  document.getElementById('u-pass-row').style.display = '';
  document.getElementById('user-modal-overlay').classList.add('open');
}

function salvarUser() {
  const idx = parseInt(document.getElementById('u-idx').value);
  const user = document.getElementById('u-user').value.toUpperCase().trim();
  const nome = document.getElementById('u-nome').value.toUpperCase().trim();
  const pass = document.getElementById('u-pass').value.trim();
  const pass2 = document.getElementById('u-pass2').value.trim();
  const role = document.getElementById('u-role').value;

  if (!user || !nome) { alert('Preencha usu√°rio e nome.'); return; }
  if (user === 'ADMIN') { alert('N√£o √© poss√≠vel criar um usu√°rio com o nome ADMIN.'); return; }

  const users = loadUsers();

  // Validate password
  if (idx === -1) {
    // new user ‚Äî password required
    if (!pass) { alert('Informe uma senha para o novo usu√°rio.'); return; }
  }
  if (pass || idx === -1) {
    if (pass !== pass2) { alert('As senhas n√£o coincidem.'); return; }
    if (pass.length < 4) { alert('A senha deve ter pelo menos 4 caracteres.'); return; }
  }

  // Check duplicate username
  const dupIdx = users.findIndex((u, i) => u.user === user && i !== idx);
  if (dupIdx !== -1) { alert('J√° existe um usu√°rio com esse nome.'); return; }

  if (idx === -1) {
    users.push({ user, nome, pass, role });
  } else {
    users[idx] = { user, nome, pass: pass || users[idx].pass, role };
  }

  saveUsers(users);
  document.getElementById('user-modal-overlay').classList.remove('open');
  renderUsuarios();
  toast(`‚úÖ Usu√°rio "${user}" salvo!`);
}

function excluirUser(i) {
  const users = loadUsers();
  const u = users[i];
  if (!u) return;
  document.getElementById('confirm-text').textContent = `Excluir usu√°rio "${u.user}" (${u.nome})?`;
  document.getElementById('confirm-btn').onclick = () => {
    users.splice(i, 1);
    saveUsers(users);
    document.getElementById('confirm-overlay').classList.remove('open');
    renderUsuarios();
    toast('üóëÔ∏è Usu√°rio exclu√≠do.');
  };
  document.getElementById('confirm-overlay').classList.add('open');
}

function abrirMinhaSenha() {
  document.getElementById('my-pass').value = '';
  document.getElementById('my-pass2').value = '';
  document.getElementById('minha-senha-overlay').classList.add('open');
}

function salvarMinhaSenha() {
  const pass = document.getElementById('my-pass').value.trim();
  const pass2 = document.getElementById('my-pass2').value.trim();
  if (!pass) { alert('Informe a nova senha.'); return; }
  if (pass !== pass2) { alert('As senhas n√£o coincidem.'); return; }
  if (pass.length < 4) { alert('A senha deve ter pelo menos 4 caracteres.'); return; }
  if (!currentUser) return;

  if (currentUser.user === 'ADMIN') {
    // Admin stores password override in localStorage
    localStorage.setItem('tn_admin_pass', pass);
    ADMIN_CRED.pass = pass;
    currentUser.pass = pass;
  } else {
    const users = loadUsers();
    const idx = users.findIndex(u => u.user === currentUser.user);
    if (idx !== -1) {
      users[idx].pass = pass;
      saveUsers(users);
      currentUser.pass = pass;
    }
  }
  document.getElementById('minha-senha-overlay').classList.remove('open');
  toast('‚úÖ Senha alterada com sucesso!');
}

function abrirAlterarSenhaAdmin() {
  // Re-use the minha-senha modal but for admin from the users page
  document.getElementById('my-pass').value = '';
  document.getElementById('my-pass2').value = '';
  document.getElementById('minha-senha-overlay').classList.add('open');
}

// ===== STORAGE =====
function loadRecords(){ try{ const s=localStorage.getItem('tn_records'); return s?JSON.parse(s):[]; }catch(e){ return []; } }
function saveRecords(){ try{ localStorage.setItem('tn_records',JSON.stringify(allRecords)); }catch(e){} }

let allRecords = loadRecords();
const TODAY = new Date('2026-02-18');

// ===== STATUS =====
function getStatus(r){
  const p=(r.prazo||'').trim();
  if(!p||p==='-') return 'pendente';
  const up=p.toUpperCase();
  if(['ENCERRADO','FINALIZADO','RESPONDIDA','PROTOCOLO'].some(s=>up.includes(s))) return 'encerrado';
  if(['URG√äNTE','URGENTE','48 HORAS'].includes(up)) return 'urgente';
  const d=new Date(p);
  if(isNaN(d)) return 'pendente';
  const diff=(d-TODAY)/86400000;
  if(diff<0) return 'vencido';
  if(diff<=7) return 'urgente';
  return 'ok';
}
function prazoFmt(r){
  const p=r.prazo||'';
  if(!p) return '‚Äî';
  if(/^\d{4}-\d{2}-\d{2}$/.test(p)) return new Date(p+'T12:00:00').toLocaleDateString('pt-BR');
  return p;
}
const SC={vencido:'s-vencido',urgente:'s-urgente',ok:'s-ok',encerrado:'s-encerrado',pendente:'s-pendente'};
const SL={vencido:'Vencido',urgente:'Urgente',ok:'No prazo',encerrado:'Encerrado',pendente:'Pendente'};

// ===== NAVIGATION =====
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  const titles={dashboard:'Dashboard',lista:'Processos',alertas:'Alertas',novo:'Novo Termo'};
  document.getElementById('page-title').textContent=titles[name]||name;
  const ni=document.querySelector(`.nav-item[onclick*="'${name}'"]`);
  if(ni) ni.classList.add('active');
  if(name==='dashboard') renderDashboard();
  if(name==='lista'){ filtered=[...allRecords]; currentPage=1; renderTable(); }
  if(name==='alertas') renderAlertas();
  if(name==='usuarios') renderUsuarios();
  if(name==='relatorios') renderRelatorios();
}

// ===== DASHBOARD =====
function renderDashboard(){
  const total=allRecords.length;
  const venc=allRecords.filter(r=>getStatus(r)==='vencido').length;
  const urg=allRecords.filter(r=>getStatus(r)==='urgente').length;
  const enc=allRecords.filter(r=>getStatus(r)==='encerrado').length;
  const multas = totalMultas();
  const multaFmt = multas.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('stats-grid').innerHTML=`
    <div class="stat-card blue"><div class="stat-label">Total de Processos</div><div class="stat-value">${total}</div><div class="stat-sub">Todos os registros</div></div>
    <div class="stat-card red"><div class="stat-label">Prazos Vencidos</div><div class="stat-value" style="color:var(--red)">${venc}</div><div class="stat-sub">Requerem aten√ß√£o</div></div>
    <div class="stat-card yellow"><div class="stat-label">Urgentes (7 dias)</div><div class="stat-value" style="color:var(--yellow)">${urg}</div><div class="stat-sub">Em alerta</div></div>
    <div class="stat-card green" style="grid-column:span 1"><div class="stat-label">üí∞ Total em Multas</div><div class="stat-value" style="font-size:20px;color:var(--green)">R$ ${multaFmt}</div><div class="stat-sub">${allRecords.filter(r=>r.valor).length} proc. com valor</div></div>`;
  updateBadges();
  // Assuntos
  const ac={};
  allRecords.forEach(r=>{ const a=r.assunto||'Outros'; ac[a]=(ac[a]||0)+1; });
  const top=Object.entries(ac).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const mx=top[0]?.[1]||1;
  document.getElementById('chart-assuntos').innerHTML=top.map(([a,c])=>`
    <div class="bar-row"><div class="bar-label" title="${a}">${a}</div>
    <div class="bar-track"><div class="bar-fill" style="width:${(c/mx*100).toFixed(0)}%"></div></div>
    <div class="bar-val">${c}</div></div>`).join('');
  // Donut
  const grp={};
  allRecords.forEach(r=>{ const k=`${r.empresa}/${r.orgao}`; grp[k]=(grp[k]||0)+1; });
  const colors=['#4f8ef7','#7c5cfc','#22c981','#f5c842','#f75c5c'];
  const ents=Object.entries(grp).sort((a,b)=>b[1]-a[1]);
  document.getElementById('legend-orgao').innerHTML=ents.map(([k,c],i)=>`
    <div class="donut-item"><div class="donut-dot" style="background:${colors[i%colors.length]}"></div><span>${k}</span><strong style="margin-left:4px">${c}</strong></div>`).join('');
  drawDonut('canvas-orgao',ents.map(([,c])=>c),colors);
  // Anos
  const an={};
  allRecords.forEach(r=>{ an[r.ano]=(an[r.ano]||0)+1; });
  const anos=Object.entries(an).sort((a,b)=>a[0].localeCompare(b[0]));
  const mxa=Math.max(...anos.map(a=>a[1]),1);
  document.getElementById('chart-anos').innerHTML=anos.map(([a,c])=>`
    <div class="bar-row"><div class="bar-label">${a}</div>
    <div class="bar-track"><div class="bar-fill" style="width:${(c/mxa*100).toFixed(0)}%;background:linear-gradient(90deg,var(--green),var(--accent))"></div></div>
    <div class="bar-val">${c}</div></div>`).join('');
  // Status prazos
  const sc2={vencido:0,urgente:0,ok:0,encerrado:0,pendente:0};
  allRecords.forEach(r=>{ sc2[getStatus(r)]++; });
  const scC={vencido:'var(--red)',urgente:'var(--orange)',ok:'var(--green)',encerrado:'var(--muted)',pendente:'var(--muted2)'};
  const tot=Math.max(Object.values(sc2).reduce((a,b)=>a+b,0),1);
  document.getElementById('chart-status').innerHTML=Object.entries(sc2).map(([k,c])=>`
    <div class="bar-row"><div class="bar-label" style="color:${scC[k]}">${SL[k]}</div>
    <div class="bar-track"><div class="bar-fill" style="width:${(c/tot*100).toFixed(0)}%;background:${scC[k]}"></div></div>
    <div class="bar-val">${c}</div></div>`).join('');
}

function drawDonut(id,values,colors){
  const canvas=document.getElementById(id);
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const total=values.reduce((a,b)=>a+b,0)||1;
  let angle=-Math.PI/2;
  ctx.clearRect(0,0,120,120);
  values.forEach((v,i)=>{
    const slice=(v/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(60,60); ctx.arc(60,60,45,angle,angle+slice); ctx.closePath();
    ctx.fillStyle=colors[i%colors.length]; ctx.fill(); angle+=slice;
  });
  ctx.beginPath(); ctx.arc(60,60,28,0,Math.PI*2);
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--surface').trim()||'#151820';
  ctx.fill();
  ctx.fillStyle='var(--muted2)'; ctx.font='bold 14px Syne,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(values.reduce((a,b)=>a+b,0),60,60);
}

// ===== LISTA =====
let filtered=[], currentPage=1, searchQ='';
const PER_PAGE=20;

function applyFilters(){
  const emp=document.getElementById('f-empresa').value;
  const org=document.getElementById('f-orgao').value;
  const ano=document.getElementById('f-ano').value;
  const tipo=document.getElementById('f-tipo').value;
  const q=searchQ.toLowerCase();
  filtered=allRecords.filter(r=>{
    if(emp&&r.empresa!==emp) return false;
    if(org&&r.orgao!==org) return false;
    if(ano&&r.ano!==ano) return false;
    if(tipo&&r.tipo!==tipo) return false;
    if(q){ const h=`${r.numero} ${r.assunto} ${r.placa} ${r.local} ${r.empresa} ${r.descricao}`.toLowerCase(); if(!h.includes(q)) return false; }
    return true;
  });
  currentPage=1; renderTable();
}

function clearFilters(){
  ['f-empresa','f-orgao','f-ano','f-tipo'].forEach(id=>document.getElementById(id).value='');
  searchQ=''; document.getElementById('search-input').value=''; applyFilters();
}

function onSearch(v){ searchQ=v; applyFilters(); }

function renderTable(){
  const total=filtered.length;
  document.getElementById('table-count').textContent=`${total} processo${total!==1?'s':''} encontrado${total!==1?'s':''}`;
  const start=(currentPage-1)*PER_PAGE;
  const data=filtered.slice(start,start+PER_PAGE);
  const tbody=document.getElementById('table-body');
  if(!data.length){
    tbody.innerHTML=`<tr><td colspan="10"><div class="empty-state">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      <p>Nenhum processo encontrado</p></div></td></tr>`;
    document.getElementById('pagination').innerHTML=''; return;
  }
  tbody.innerHTML=data.map(r=>{
    const st=getStatus(r);
    const pc=st==='vencido'?'prazo-vencido':st==='urgente'?'prazo-urgente':'prazo-date';
    const ec=r.empresa==='Rio Novo'?'tag-rn':r.empresa==='Xavante'?'tag-xv':r.empresa==='Novo Caminho'?'tag-nc':'tag-tr';
    const oc=r.orgao==='AGER'?'tag-ager':'tag-antt';
    return `<tr onclick="openDetalhe(${r.id})">
      <td style="font-family:var(--font-head);font-size:12px;font-weight:700;color:var(--muted2)">${r.numero||'‚Äî'}</td>
      <td><span class="tag ${ec}">${r.empresa}</span></td>
      <td><span class="tag ${oc}">${r.orgao}</span></td>
      <td style="font-size:11px;color:var(--muted2)">${r.tipo}</td>
      <td class="td-assunto" title="${r.assunto||''}">${r.assunto||'‚Äî'}</td>
      <td style="font-size:12px;color:var(--muted2)">${r.local||'‚Äî'}</td>
      <td style="font-size:12px;font-family:var(--font-head);font-weight:700">${r.placa||'‚Äî'}</td>
      <td class="${pc}">${prazoFmt(r)}</td>
      <td><span class="status-dot ${SC[st]}">${SL[st]}</span></td>
      <td>${r.valor?`<span class="valor-badge" style="font-size:10px">R$ ${Number(r.valor).toLocaleString('pt-BR',{minimumFractionDigits:2})}</span>`:'‚Äî'}</td>
      <td onclick="event.stopPropagation()">
        <div class="row-actions">
          <div class="row-btn" title="Editar" onclick="openEditar(${r.id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </div>
          <div class="row-btn del" title="Excluir" onclick="pedirExclusao(${r.id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
          </div>
        </div>
      </td>
    </tr>`;
  }).join('');
  renderPag(total);
}

function renderPag(total){
  const tp=Math.ceil(total/PER_PAGE);
  const pag=document.getElementById('pagination');
  if(tp<=1){ pag.innerHTML=''; return; }
  let h=`<div class="page-btn ${currentPage===1?'disabled':''}" onclick="goPage(${currentPage-1})">‚Äπ</div>`;
  for(let i=1;i<=tp;i++){
    if(i===1||i===tp||Math.abs(i-currentPage)<=2) h+=`<div class="page-btn ${i===currentPage?'active':''}" onclick="goPage(${i})">${i}</div>`;
    else if(Math.abs(i-currentPage)===3) h+=`<div class="page-btn disabled">‚Ä¶</div>`;
  }
  h+=`<div class="page-btn ${currentPage===tp?'disabled':''}" onclick="goPage(${currentPage+1})">‚Ä∫</div>`;
  h+=`<span class="page-info">P√°g. ${currentPage} de ${tp}</span>`;
  pag.innerHTML=h;
}

function goPage(p){ currentPage=p; renderTable(); }

// ===== ALERTAS =====
function renderAlertas(){
  const venc=allRecords.filter(r=>getStatus(r)==='vencido');
  const urg=allRecords.filter(r=>getStatus(r)==='urgente');
  const ok=allRecords.filter(r=>getStatus(r)==='ok');
  document.getElementById('alerta-vencidos').textContent=venc.length;
  document.getElementById('alerta-urgentes').textContent=urg.length;
  document.getElementById('alerta-ok').textContent=ok.length;
  const items=[...venc.map(r=>({r,cls:'red',lbl:'VENCIDO'})),...urg.map(r=>({r,cls:'orange',lbl:'URGENTE'}))];
  const list=document.getElementById('alerts-list');
  if(!items.length){ list.innerHTML=`<div style="text-align:center;padding:60px;color:var(--muted)"><div style="font-size:48px;margin-bottom:12px">‚úÖ</div><p>Nenhum prazo urgente ou vencido.</p></div>`; return; }
  list.innerHTML=items.map(({r,cls,lbl})=>`
    <div class="alert-item ${cls}" onclick="openDetalhe(${r.id})">
      <div class="alert-icon ${cls}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
      <div class="alert-content">
        <div class="alert-title">${r.numero||'‚Äî'} ‚Äî ${r.assunto||'‚Äî'}</div>
        <div class="alert-sub">${r.empresa} ¬∑ ${r.orgao} ¬∑ ${r.ano}${r.placa?' ¬∑ '+r.placa:''}</div>
      </div>
      <div>
        <span class="tag" style="background:${cls==='red'?'rgba(247,92,92,.15)':'rgba(247,146,79,.15)'};color:${cls==='red'?'var(--red)':'var(--orange)'}">${lbl}</span>
        <div class="alert-date" style="margin-top:4px">${prazoFmt(r)}</div>
      </div>
    </div>`).join('');
}

// ===== DETALHE MODAL =====
function openDetalhe(id){
  const r=allRecords.find(x=>x.id===id);
  if(!r) return;
  const st=getStatus(r);
  const pc=st==='vencido'?'prazo-vencido':st==='urgente'?'prazo-urgente':'';
  document.getElementById('det-title').textContent=r.numero||'Sem n√∫mero';
  document.getElementById('det-sub').textContent=`${r.empresa} ¬∑ ${r.orgao} ¬∑ ${r.ano}`;
  document.getElementById('det-body').innerHTML=`
    <div class="detail-grid">
      <div class="detail-field"><label>Empresa</label><div class="val">${r.empresa||'‚Äî'}</div></div>
      <div class="detail-field"><label>√ìrg√£o</label><div class="val">${r.orgao||'‚Äî'}</div></div>
      <div class="detail-field"><label>Tipo</label><div class="val">${r.tipo||'‚Äî'}</div></div>
      <div class="detail-field"><label>Setor</label><div class="val">${r.setor||'‚Äî'}</div></div>
      <div class="detail-field"><label>Data de Entrada</label><div class="val">${r.data_entrada?new Date(r.data_entrada+'T12:00:00').toLocaleDateString('pt-BR'):'‚Äî'}</div></div>
      <div class="detail-field"><label>Prazo Final</label><div class="val ${pc}">${prazoFmt(r)}</div></div>
      <div class="detail-field"><label>Local</label><div class="val">${r.local||'‚Äî'}</div></div>
      <div class="detail-field"><label>Ve√≠culo</label><div class="val mono">${[r.prefixo,r.placa].filter(x=>x&&x!=='-').join(' / ')||'‚Äî'}</div></div>
    </div>
    <div class="detail-field" style="margin-bottom:14px"><label>Assunto</label><div class="val" style="font-size:14px;font-weight:500">${r.assunto||'‚Äî'}</div></div>
    ${r.descricao?`<div class="detail-field"><label>Descri√ß√£o</label><div class="desc-box">${r.descricao}</div></div>`:''}
    ${r.obs?`<div class="detail-field" style="margin-top:12px"><label>Observa√ß√µes</label><div class="desc-box">${r.obs}</div></div>`:''}
    <div class="status-select-wrap">
      <label>Status:</label>
      <span class="status-dot ${SC[st]}" style="margin-right:10px">${SL[st]}</span>
      <select class="filter-select" onchange="atualizarStatus(${r.id},this.value)" style="flex:1">
        <option value="">‚Äî Atualizar status ‚Äî</option>
        <option>PENDENTE</option><option>EM AN√ÅLISE</option><option>RESPONDIDA</option><option>PROTOCOLADO</option><option>ENCERRADO</option>
      </select>
    </div>
    ${r.valor?`<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)"><label style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);font-weight:600;display:block;margin-bottom:6px">Valor da Autua√ß√£o</label><span class="valor-badge">R$ ${Number(r.valor).toLocaleString('pt-BR',{minimumFractionDigits:2})}</span></div>`:''}
    ${(r.img_autua||r.img_defesa||r.img_decisao)?`
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);font-weight:600;margin-bottom:10px">Documentos</div>
      <div class="img-thumb-row">
        ${r.img_autua?`<div class="img-thumb-wrap"><img class="img-thumb" src="${r.img_autua}" onclick="viewImg('${r.img_autua}')" title="Ver autua√ß√£o"><div class="img-thumb-label">Autua√ß√£o</div></div>`:''}
        ${r.img_defesa?`<div class="img-thumb-wrap"><img class="img-thumb" src="${r.img_defesa}" onclick="viewImg('${r.img_defesa}')" title="Ver defesa"><div class="img-thumb-label">Defesa</div></div>`:''}
        ${r.img_decisao?`<div class="img-thumb-wrap"><img class="img-thumb" src="${r.img_decisao}" onclick="viewImg('${r.img_decisao}')" title="Ver decis√£o"><div class="img-thumb-label">Decis√£o</div></div>`:''}
      </div>
    </div>`:''}
    `;
  document.getElementById('det-btn-excluir').onclick=()=>pedirExclusao(id);
  document.getElementById('det-btn-editar').onclick=()=>openEditar(id);
  document.getElementById('modal-detail-overlay').classList.add('open');
}

function atualizarStatus(id,val){
  if(!val) return;
  const r=allRecords.find(x=>x.id===id);
  if(r){ r.status=val; if(val==='ENCERRADO') r.prazo='ENCERRADO'; }
  saveRecords(); updateBadges(); applyFilters();
}

// ===== EDITAR =====
function openEditar(id){
  const r=allRecords.find(x=>x.id===id);
  if(!r) return;
  document.getElementById('edit-sub').textContent=`${r.empresa} ¬∑ ${r.orgao} ¬∑ ${r.ano}`;
  document.getElementById('e-id').value=r.id;
  document.getElementById('e-empresa').value=r.empresa||'';
  document.getElementById('e-orgao').value=r.orgao||'';
  document.getElementById('e-tipo').value=r.tipo||'';
  document.getElementById('e-numero').value=r.numero||'';
  document.getElementById('e-data').value=r.data_entrada||'';
  document.getElementById('e-prazo').value=/^\d{4}-\d{2}-\d{2}$/.test(r.prazo||'')?r.prazo:'';
  document.getElementById('e-assunto').value=r.assunto||'';
  document.getElementById('e-setor').value=r.setor||'';
  document.getElementById('e-local').value=r.local||'';
  document.getElementById('e-prefixo').value=r.prefixo||'';
  document.getElementById('e-placa').value=r.placa||'';
  document.getElementById('e-descricao').value=r.descricao||'';
  document.getElementById('e-status').value=r.status||'PENDENTE';
  document.getElementById('e-obs').value=r.obs||'';
  document.getElementById('e-valor').value=r.valor||'';
  // Load existing images
  ['autua','defesa','decisao'].forEach(t=>resetUploadBox('e',t));
  if (!tempUploads['e']) tempUploads['e']={};
  if(r.img_autua) loadUploadBox('e','autua',r.img_autua);
  if(r.img_defesa) loadUploadBox('e','defesa',r.img_defesa);
  if(r.img_decisao) loadUploadBox('e','decisao',r.img_decisao);
  document.getElementById('modal-detail-overlay').classList.remove('open');
  document.getElementById('modal-edit-overlay').classList.add('open');
}

function salvarEdicao(){
  const id=parseInt(document.getElementById('e-id').value);
  const empresa=document.getElementById('e-empresa').value;
  const orgao=document.getElementById('e-orgao').value;
  const tipo=document.getElementById('e-tipo').value;
  const assunto=document.getElementById('e-assunto').value;
  const data=document.getElementById('e-data').value;
  if(!empresa||!orgao||!tipo||!assunto||!data){ alert('Preencha os campos obrigat√≥rios (*)'); return; }
  const idx=allRecords.findIndex(x=>x.id===id);
  if(idx===-1) return;
  allRecords[idx]={
    ...allRecords[idx], empresa, orgao, tipo,
    numero: document.getElementById('e-numero').value||allRecords[idx].numero,
    data_entrada: data,
    prazo: document.getElementById('e-prazo').value||allRecords[idx].prazo,
    assunto: assunto.toUpperCase(),
    setor: document.getElementById('e-setor').value,
    local: document.getElementById('e-local').value,
    prefixo: document.getElementById('e-prefixo').value,
    placa: document.getElementById('e-placa').value,
    descricao: document.getElementById('e-descricao').value,
    status: document.getElementById('e-status').value,
    obs: document.getElementById('e-obs').value,
    valor: document.getElementById('e-valor').value||'',
    img_autua: tempUploads['e']?.autua !== undefined ? tempUploads['e'].autua : allRecords[idx].img_autua||'',
    img_defesa: tempUploads['e']?.defesa !== undefined ? tempUploads['e'].defesa : allRecords[idx].img_defesa||'',
    img_decisao: tempUploads['e']?.decisao !== undefined ? tempUploads['e'].decisao : allRecords[idx].img_decisao||'',
    ano: new Date(data+'T12:00:00').getFullYear().toString(),
  };
  saveRecords();
  document.getElementById('modal-edit-overlay').classList.remove('open');
  applyFilters(); renderDashboard(); updateBadges();
  toast('‚úÖ Processo atualizado!');
}

// ===== EXCLUIR =====
function pedirExclusao(id){
  const r=allRecords.find(x=>x.id===id);
  if(!r) return;
  document.getElementById('confirm-text').textContent=`Excluir "${r.numero||'sem n√∫mero'}" ‚Äî ${r.empresa} ¬∑ ${r.orgao}?`;
  document.getElementById('confirm-btn').onclick=()=>{
    allRecords=allRecords.filter(x=>x.id!==id);
    saveRecords();
    document.getElementById('confirm-overlay').classList.remove('open');
    document.getElementById('modal-detail-overlay').classList.remove('open');
    applyFilters(); renderDashboard(); updateBadges();
    toast('üóëÔ∏è Processo exclu√≠do.');
  };
  document.getElementById('confirm-overlay').classList.add('open');
}

// ===== NOVO =====
function salvarNovo(){
  const empresa=document.getElementById('n-empresa').value;
  const orgao=document.getElementById('n-orgao').value;
  const tipo=document.getElementById('n-tipo').value;
  const assunto=document.getElementById('n-assunto').value;
  const data=document.getElementById('n-data').value;
  if(!empresa||!orgao||!tipo||!assunto||!data){ alert('Preencha os campos obrigat√≥rios (*)'); return; }
  const newId=allRecords.length>0?Math.max(...allRecords.map(r=>r.id))+1:0;
  const rec={
    id:newId, empresa, orgao, tipo,
    numero: document.getElementById('n-numero').value||`TN-${String(newId+1).padStart(4,'0')}`,
    data_entrada: data,
    prazo: document.getElementById('n-prazo').value||'',
    assunto: assunto.toUpperCase(),
    setor: document.getElementById('n-setor').value,
    local: document.getElementById('n-local').value,
    prefixo: document.getElementById('n-prefixo').value,
    placa: document.getElementById('n-placa').value,
    descricao: document.getElementById('n-descricao').value,
    status: document.getElementById('n-status').value,
    obs: document.getElementById('n-obs').value,
    valor: document.getElementById('n-valor').value||'',
    img_autua: tempUploads['n']?.autua||'',
    img_defesa: tempUploads['n']?.defesa||'',
    img_decisao: tempUploads['n']?.decisao||'',
    ano: new Date(data+'T12:00:00').getFullYear().toString(),
  };
  allRecords.unshift(rec);
  saveRecords();
  ['n-empresa','n-orgao','n-tipo','n-setor','n-status'].forEach(id=>document.getElementById(id).value='');
  ['n-numero','n-data','n-prazo','n-assunto','n-local','n-prefixo','n-placa','n-descricao','n-obs','n-valor'].forEach(id=>document.getElementById(id).value='');
  ['autua','defesa','decisao'].forEach(t=>resetUploadBox('n',t));
  delete tempUploads['n'];
  showPage('lista');
  toast(`‚úÖ Processo "${rec.numero}" cadastrado!`);
}


// ===== UPLOADS =====
const tempUploads = {}; // prefix -> {autua, defesa, decisao}

function handleUpload(input, prefix, tipo) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = e.target.result;
    if (!tempUploads[prefix]) tempUploads[prefix] = {};
    tempUploads[prefix][tipo] = data;
    const box = document.getElementById(`${prefix}-box-${tipo}`);
    if (box) {
      const isImg = file.type.startsWith('image/');
      box.classList.add('has-image');
      box.innerHTML = `
        <div class="upload-remove" onclick="removeUpload('${prefix}','${tipo}',event)">‚úï</div>
        ${isImg ? `<img class="upload-preview" src="${data}">` : `<div style="font-size:28px;margin-bottom:6px">üìé</div>`}
        <div class="upload-box-label" style="color:var(--green)">${tipo.charAt(0).toUpperCase()+tipo.slice(1)}</div>
        <div class="upload-box-sub" style="color:var(--muted2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:120px">${file.name}</div>`;
    }
  };
  reader.readAsDataURL(file);
}

function removeUpload(prefix, tipo, event) {
  event.stopPropagation();
  if (tempUploads[prefix]) delete tempUploads[prefix][tipo];
  const box = document.getElementById(`${prefix}-box-${tipo}`);
  if (box) {
    box.classList.remove('has-image');
    const icons = {autua:'üìÑ', defesa:'üõ°Ô∏è', decisao:'‚öñÔ∏è'};
    const labels = {autua:'Autua√ß√£o', defesa:'Defesa', decisao:'Decis√£o'};
    box.innerHTML = `
      <input type="file" accept="image/*,application/pdf" onchange="handleUpload(this,'${prefix}','${tipo}')">
      <div class="upload-box-icon">${icons[tipo]}</div>
      <div class="upload-box-label">${labels[tipo]}</div>
      <div class="upload-box-sub">Clique ou arraste</div>`;
  }
}

function resetUploadBox(prefix, tipo) {
  if (tempUploads[prefix]) delete tempUploads[prefix][tipo];
  const box = document.getElementById(`${prefix}-box-${tipo}`);
  if (box) {
    box.classList.remove('has-image');
    const icons = {autua:'üìÑ', defesa:'üõ°Ô∏è', decisao:'‚öñÔ∏è'};
    const labels = {autua:'Autua√ß√£o', defesa:'Defesa', decisao:'Decis√£o'};
    box.innerHTML = `
      <input type="file" accept="image/*,application/pdf" onchange="handleUpload(this,'${prefix}','${tipo}')">
      <div class="upload-box-icon">${icons[tipo]}</div>
      <div class="upload-box-label">${labels[tipo]}</div>
      <div class="upload-box-sub">Clique, arraste ou Ctrl+V</div>`;
    box.onclick = () => setActiveUpload(prefix, tipo);
  }
}

function loadUploadBox(prefix, tipo, data) {
  if (!data) return;
  if (!tempUploads[prefix]) tempUploads[prefix] = {};
  tempUploads[prefix][tipo] = data;
  const box = document.getElementById(`${prefix}-box-${tipo}`);
  if (!box) return;
  const isImg = data.startsWith('data:image');
  box.classList.add('has-image');
  box.innerHTML = `
    <div class="upload-remove" onclick="removeUpload('${prefix}','${tipo}',event)">‚úï</div>
    ${isImg ? `<img class="upload-preview" src="${data}">` : `<div style="font-size:28px;margin-bottom:6px">üìé</div>`}
    <div class="upload-box-label" style="color:var(--green)">${tipo.charAt(0).toUpperCase()+tipo.slice(1)}</div>
    <div class="upload-box-sub" style="color:var(--muted2)">Arquivo carregado</div>`;
}

function viewImg(src) {
  document.getElementById('img-viewer-src').src = src;
  document.getElementById('img-viewer').classList.add('open');
}

// Dashboard: total multas
function totalMultas() {
  return allRecords.reduce((acc, r) => acc + (parseFloat(r.valor)||0), 0);
}


// ===== CTRL+V PASTE INTO UPLOAD BOXES =====
let activeUploadPrefix = null;
let activeUploadTipo = null;

function setActiveUpload(prefix, tipo) {
  activeUploadPrefix = prefix;
  activeUploadTipo = tipo;
}

document.addEventListener('paste', function(e) {
  if (!activeUploadPrefix || !activeUploadTipo) return;
  const items = (e.clipboardData || e.originalEvent?.clipboardData)?.items;
  if (!items) return;
  for (let i = 0; i < items.length; i++) {
    if (items[i].type.startsWith('image/')) {
      const blob = items[i].getAsFile();
      const reader = new FileReader();
      reader.onload = function(ev) {
        const data = ev.target.result;
        if (!tempUploads[activeUploadPrefix]) tempUploads[activeUploadPrefix] = {};
        tempUploads[activeUploadPrefix][activeUploadTipo] = data;
        const box = document.getElementById(`${activeUploadPrefix}-box-${activeUploadTipo}`);
        if (box) {
          box.classList.add('has-image');
          box.innerHTML = `
            <div class="upload-remove" onclick="removeUpload('${activeUploadPrefix}','${activeUploadTipo}',event)">‚úï</div>
            <img class="upload-preview" src="${data}">
            <div class="upload-box-label" style="color:var(--green)">${activeUploadTipo.charAt(0).toUpperCase()+activeUploadTipo.slice(1)}</div>
            <div class="upload-box-sub" style="color:var(--muted2)">Colado com Ctrl+V</div>`;
        }
        toast('üìã Imagem colada com sucesso!');
      };
      reader.readAsDataURL(blob);
      break;
    }
  }
});


// ===== RELAT√ìRIOS =====
function getRelFiltrados() {
  const emp = document.getElementById('r-empresa')?.value || '';
  const org = document.getElementById('r-orgao')?.value || '';
  const ano = document.getElementById('r-ano')?.value || '';
  const de  = document.getElementById('r-de')?.value || '';
  const ate = document.getElementById('r-ate')?.value || '';
  return allRecords.filter(r => {
    if (emp && r.empresa !== emp) return false;
    if (org && r.orgao !== org) return false;
    if (ano && r.ano !== ano) return false;
    if (de && r.data_entrada && r.data_entrada < de) return false;
    if (ate && r.data_entrada && r.data_entrada > ate) return false;
    return true;
  });
}

function limparFiltrosRel() {
  ['r-empresa','r-orgao','r-ano','r-de','r-ate'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  renderRelatorios();
}

function barChart(data, colorFn) {
  // data: [{label, val, extra?}]
  const max = Math.max(...data.map(d => d.val), 1);
  return data.map(d => `
    <div class="bar-row">
      <div class="bar-label" title="${d.label}">${d.label}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(d.val/max*100).toFixed(0)}%;background:${colorFn ? colorFn(d.label) : 'linear-gradient(90deg,var(--accent),var(--accent2))'}"></div></div>
      <div class="bar-val">${d.val}${d.extra ? ' <span style="font-size:10px;color:var(--muted)">'+d.extra+'</span>' : ''}</div>
    </div>`).join('');
}

function repTable(headers, rows) {
  return `<table class="rep-table">
    <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>
  </table>`;
}

function fmtMoney(v) {
  return 'R$ ' + Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2});
}

function renderRelatorios() {
  const data = getRelFiltrados();
  const total = data.length;

  if (!total) {
    ['rep-resumo','rep-empresa','rep-orgao','rep-status','rep-local','rep-multas','rep-mensal']
      .forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = `<div class="report-card-title">Sem dados para os filtros selecionados.</div>`; });
    return;
  }

  const venc = data.filter(r=>getStatus(r)==='vencido').length;
  const urg  = data.filter(r=>getStatus(r)==='urgente').length;
  const enc  = data.filter(r=>getStatus(r)==='encerrado').length;
  const totalMulta = data.reduce((s,r)=>s+(parseFloat(r.valor)||0), 0);
  const comValor = data.filter(r=>r.valor).length;

  // === RESUMO ===
  document.getElementById('rep-resumo').innerHTML = `
    <div class="report-card-title">üìä Resumo Geral</div>
    <div class="report-grid-3">
      <div class="rep-stat"><div class="rep-stat-val">${total}</div><div class="rep-stat-label">Total de Processos</div></div>
      <div class="rep-stat"><div class="rep-stat-val" style="color:var(--red)">${venc}</div><div class="rep-stat-label">Prazos Vencidos</div></div>
      <div class="rep-stat"><div class="rep-stat-val" style="color:var(--orange)">${urg}</div><div class="rep-stat-label">Urgentes</div></div>
      <div class="rep-stat"><div class="rep-stat-val" style="color:var(--green)">${enc}</div><div class="rep-stat-label">Encerrados</div></div>
      <div class="rep-stat"><div class="rep-stat-val" style="color:var(--green);font-size:18px">${fmtMoney(totalMulta)}</div><div class="rep-stat-label">Total em Multas</div></div>
      <div class="rep-stat"><div class="rep-stat-val">${comValor}</div><div class="rep-stat-label">Com Valor Informado</div></div>
    </div>`;

  // === POR EMPRESA ===
  const empMap = {};
  data.forEach(r => { empMap[r.empresa] = (empMap[r.empresa]||0)+1; });
  const empData = Object.entries(empMap).sort((a,b)=>b[1]-a[1]);
  const empColors = {'Rio Novo':'var(--accent)','Xavante':'var(--accent2)','Novo Caminho':'var(--green)','Tarum√£':'var(--orange)'};
  document.getElementById('rep-empresa').innerHTML = `
    <div class="report-card-title">üè¢ Processos por Empresa</div>
    ${barChart(empData.map(([l,v])=>({label:l,val:v,extra:`(${(v/total*100).toFixed(0)}%)`})), l=>empColors[l]||'var(--accent)')}
    <div style="margin-top:12px">${repTable(['Empresa','Qtd','%'],[...empData.map(([e,v])=>[e,v,(v/total*100).toFixed(1)+'%'])])}</div>`;

  // === POR √ìRG√ÉO ===
  const orgMap = {};
  data.forEach(r => { orgMap[r.orgao] = (orgMap[r.orgao]||0)+1; });
  const orgData = Object.entries(orgMap).sort((a,b)=>b[1]-a[1]);
  const orgColors = {'AGER':'var(--green)','ANTT':'var(--yellow)'};
  document.getElementById('rep-orgao').innerHTML = `
    <div class="report-card-title">‚öñÔ∏è Processos por √ìrg√£o</div>
    ${barChart(orgData.map(([l,v])=>({label:l,val:v,extra:`(${(v/total*100).toFixed(0)}%)`})), l=>orgColors[l]||'var(--accent)')}
    <div style="margin-top:12px">${repTable(['√ìrg√£o','Qtd','%'],[...orgData.map(([o,v])=>[o,v,(v/total*100).toFixed(1)+'%'])])}</div>`;

  // === POR STATUS ===
  const stMap = {vencido:0,urgente:0,ok:0,encerrado:0,pendente:0};
  data.forEach(r=>{ stMap[getStatus(r)]++; });
  const stColors = {vencido:'var(--red)',urgente:'var(--orange)',ok:'var(--green)',encerrado:'var(--muted)',pendente:'var(--muted2)'};
  const stLabels = {vencido:'Vencido',urgente:'Urgente',ok:'No Prazo',encerrado:'Encerrado',pendente:'Pendente'};
  document.getElementById('rep-status').innerHTML = `
    <div class="report-card-title">üö¶ Situa√ß√£o dos Prazos</div>
    ${barChart(Object.entries(stMap).filter(([,v])=>v>0).map(([k,v])=>({label:stLabels[k],val:v})), l => {
      const k = Object.keys(stLabels).find(k=>stLabels[k]===l);
      return stColors[k]||'var(--accent)';
    })}
    <div style="margin-top:12px">${repTable(['Status','Qtd','%'],Object.entries(stMap).filter(([,v])=>v>0).map(([k,v])=>[`<span style="color:${stColors[k]}">${stLabels[k]}</span>`,v,(v/total*100).toFixed(1)+'%']))}</div>`;

  // === POR LOCALIDADE ===
  const locMap = {};
  data.forEach(r=>{ const l=r.local||'N√ÉO INFORMADO'; locMap[l]=(locMap[l]||0)+1; });
  const locData = Object.entries(locMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
  document.getElementById('rep-local').innerHTML = `
    <div class="report-card-title">üìç Processos por Localidade</div>
    ${barChart(locData.map(([l,v])=>({label:l,val:v})))}
    <div style="margin-top:12px">${repTable(['Local','Qtd','%'],locData.map(([l,v])=>[l,v,(v/total*100).toFixed(1)+'%']))}</div>`;

  // === MULTAS POR EMPRESA ===
  const multaEmp = {};
  data.filter(r=>r.valor).forEach(r=>{
    if(!multaEmp[r.empresa]) multaEmp[r.empresa]={total:0,qtd:0};
    multaEmp[r.empresa].total += parseFloat(r.valor)||0;
    multaEmp[r.empresa].qtd++;
  });
  const multaRows = Object.entries(multaEmp).sort((a,b)=>b[1].total-a[1].total);
  document.getElementById('rep-multas').innerHTML = `
    <div class="report-card-title">üí∞ Total de Multas por Empresa</div>
    ${multaRows.length ? `
    ${barChart(multaRows.map(([e,d])=>({label:e,val:d.total,extra:fmtMoney(d.total)})), l=>empColors[l]||'var(--accent)')}
    <div style="margin-top:12px">${repTable(
      ['Empresa','Qtd com Valor','Total','M√©dia por Processo'],
      multaRows.map(([e,d])=>[e, d.qtd, `<strong>${fmtMoney(d.total)}</strong>`, fmtMoney(d.total/d.qtd)])
    )}
    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:20px;">
      <span style="font-size:12px;color:var(--muted)">TOTAL GERAL:</span>
      <strong style="color:var(--green)">${fmtMoney(totalMulta)}</strong>
    </div></div>` : '<p style="color:var(--muted);font-size:13px">Nenhum processo com valor informado.</p>'}`;

  // === EVOLU√á√ÉO MENSAL ===
  const mensal = {};
  data.forEach(r=>{
    if(!r.data_entrada) return;
    const ym = r.data_entrada.substring(0,7);
    mensal[ym] = (mensal[ym]||0)+1;
  });
  const mensalData = Object.entries(mensal).sort((a,b)=>a[0].localeCompare(b[0]));
  const mensalFmt = ([ym]) => {
    const [y,m] = ym.split('-');
    const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    return `${meses[parseInt(m)-1]}/${y}`;
  };
  document.getElementById('rep-mensal').innerHTML = `
    <div class="report-card-title">üìÖ Evolu√ß√£o Mensal de Autua√ß√µes</div>
    ${mensalData.length ? barChart(mensalData.map(e=>({label:mensalFmt(e),val:e[1]})),()=>'linear-gradient(90deg,var(--accent2),var(--accent))') : '<p style="color:var(--muted);font-size:13px">Sem dados de datas.</p>'}
    ${mensalData.length ? `<div style="margin-top:12px">${repTable(['M√™s/Ano','Quantidade'],mensalData.map(e=>[mensalFmt(e),e[1]]))}</div>` : ''}`;
}

// ===== EXPORT PDF =====
function exportarPDF() {
  // Load jsPDF dynamically
  if (window.jspdf) { gerarPDF(); return; }
  const s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
  s.onload = () => {
    const s2 = document.createElement('script');
    s2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
    s2.onload = gerarPDF;
    document.head.appendChild(s2);
  };
  document.head.appendChild(s);
  toast('‚è≥ Gerando PDF...');
}

function gerarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const data = getRelFiltrados();
  const total = data.length;
  const pageW = 210;
  const margin = 14;
  const contentW = pageW - margin * 2;
  let y = 0;

  const CORES = {
    azul:   [79, 142, 247],
    roxo:   [124, 92, 252],
    verde:  [34, 201, 129],
    amarelo:[245, 200, 66],
    vermelho:[247, 92, 92],
    laranja:[247, 146, 79],
    cinza:  [156, 163, 175],
    escuro: [17, 24, 39],
    muted:  [107, 114, 128],
    border: [229, 231, 235],
    bg:     [248, 250, 252],
  };

  function novaPage() {
    doc.addPage();
    y = 14;
    rodape();
  }

  function checkY(needed) {
    if (y + needed > 272) novaPage();
  }

  function rodape() {
    const pg = doc.internal.getCurrentPageInfo().pageNumber;
    const total = doc.internal.getNumberOfPages();
    doc.setFont('helvetica','normal');
    doc.setFontSize(8);
    doc.setTextColor(...CORES.muted);
    doc.text(`P√°gina ${pg} de ${total}`, pageW - margin, 287, {align:'right'});
    doc.text('Sistema de Termos de Notifica√ß√£o ‚Äî AGER / ANTT', margin, 287);
    doc.setDrawColor(...CORES.border);
    doc.line(margin, 283, pageW - margin, 283);
  }

  function cabecalho() {
    // Header bar
    doc.setFillColor(...CORES.azul);
    doc.rect(0, 0, pageW, 28, 'F');
    // Gradient bar (simulate with second rect)
    doc.setFillColor(...CORES.roxo);
    doc.rect(pageW * 0.6, 0, pageW * 0.4, 28, 'F');

    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.text('RELAT√ìRIO DE TERMOS DE NOTIFICA√á√ÉO', margin, 12);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text('AGER & ANTT ‚Äî Setor Jur√≠dico', margin, 19);

    const dataStr = new Date().toLocaleDateString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
    doc.text(`Gerado em: ${dataStr}`, pageW - margin, 19, {align:'right'});

    // Filtros aplicados
    const emp = document.getElementById('r-empresa')?.value;
    const org = document.getElementById('r-orgao')?.value;
    const ano = document.getElementById('r-ano')?.value;
    const de  = document.getElementById('r-de')?.value;
    const ate = document.getElementById('r-ate')?.value;
    let filtros = [];
    if (emp) filtros.push('Empresa: ' + emp);
    if (org) filtros.push('√ìrg√£o: ' + org);
    if (ano) filtros.push('Ano: ' + ano);
    if (de)  filtros.push('De: ' + de);
    if (ate) filtros.push('At√©: ' + ate);
    if (filtros.length) {
      doc.setFontSize(7.5);
      doc.text('Filtros: ' + filtros.join(' | '), margin, 25);
    }

    y = 36;
    rodape();
  }

  function sectionTitle(titulo, emoji) {
    checkY(14);
    doc.setFillColor(...CORES.bg);
    doc.roundedRect(margin, y, contentW, 9, 1.5, 1.5, 'F');
    doc.setDrawColor(...CORES.azul);
    doc.setLineWidth(0.5);
    doc.line(margin, y + 9, margin + contentW, y + 9);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.setTextColor(...CORES.escuro);
    doc.text((emoji ? emoji + '  ' : '') + titulo.toUpperCase(), margin + 4, y + 6.2);
    y += 13;
  }

  function statBoxes(items) {
    // items: [{label, val, color}]
    const cols = Math.min(items.length, 3);
    const boxW = (contentW - (cols - 1) * 4) / cols;
    checkY(22);
    items.forEach((item, i) => {
      const row = Math.floor(i / cols);
      const col = i % cols;
      if (col === 0 && i > 0) { y += 22; checkY(22); }
      const x = margin + col * (boxW + 4);
      const bY = y;

      doc.setFillColor(...CORES.bg);
      doc.roundedRect(x, bY, boxW, 18, 2, 2, 'F');
      doc.setDrawColor(...CORES.border);
      doc.setLineWidth(0.3);
      doc.roundedRect(x, bY, boxW, 18, 2, 2, 'S');

      // colored top bar
      doc.setFillColor(...(item.color || CORES.azul));
      doc.roundedRect(x, bY, boxW, 2, 1, 1, 'F');

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.setTextColor(...(item.color || CORES.escuro));
      doc.text(String(item.val), x + boxW / 2, bY + 10, {align:'center'});

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.setTextColor(...CORES.muted);
      doc.text(item.label.toUpperCase(), x + boxW / 2, bY + 15, {align:'center'});
    });
    y += 24;
  }

  function barras(items, colorFn) {
    // items: [{label, val, pct}]
    const barH = 5;
    const labelW = 55;
    const barW = contentW - labelW - 20;
    items.forEach(item => {
      checkY(9);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.setTextColor(...CORES.escuro);
      doc.text(String(item.label).substring(0, 30), margin, y + 4);

      // track
      doc.setFillColor(...CORES.border);
      doc.roundedRect(margin + labelW, y, barW, barH, 1, 1, 'F');

      // fill
      const fillW = Math.max((item.pct / 100) * barW, 1);
      const cor = colorFn ? colorFn(item.label) : CORES.azul;
      doc.setFillColor(...cor);
      doc.roundedRect(margin + labelW, y, fillW, barH, 1, 1, 'F');

      // value
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(...CORES.escuro);
      doc.text(String(item.val), margin + labelW + barW + 3, y + 4);

      y += 8;
    });
    y += 2;
  }

  function tabela(headers, rows, colWidths) {
    checkY(20);
    doc.autoTable({
      startY: y,
      head: [headers],
      body: rows,
      margin: { left: margin, right: margin },
      columnStyles: colWidths ? Object.fromEntries(colWidths.map((w, i) => [i, {cellWidth: w}])) : {},
      headStyles: {
        fillColor: CORES.azul,
        textColor: [255, 255, 255],
        fontSize: 8,
        fontStyle: 'bold',
        halign: 'left',
      },
      bodyStyles: { fontSize: 8, textColor: CORES.escuro },
      alternateRowStyles: { fillColor: CORES.bg },
      tableLineColor: CORES.border,
      tableLineWidth: 0.2,
      didDrawPage: (d) => { y = d.cursor.y + 4; rodape(); },
    });
    y = doc.lastAutoTable.finalY + 6;
  }

  // ========== BUILD PDF ==========
  cabecalho();

  // ---- RESUMO ----
  sectionTitle('Resumo Geral', 'üìä');
  const venc = data.filter(r => getStatus(r) === 'vencido').length;
  const urg  = data.filter(r => getStatus(r) === 'urgente').length;
  const enc  = data.filter(r => getStatus(r) === 'encerrado').length;
  const pend = data.filter(r => getStatus(r) === 'pendente').length;
  const totalM = data.reduce((s, r) => s + (parseFloat(r.valor) || 0), 0);
  const comVal = data.filter(r => r.valor).length;

  statBoxes([
    {label: 'Total de Processos', val: total, color: CORES.azul},
    {label: 'Prazos Vencidos',    val: venc,  color: CORES.vermelho},
    {label: 'Urgentes (7 dias)',  val: urg,   color: CORES.laranja},
    {label: 'Encerrados',         val: enc,   color: CORES.verde},
    {label: 'Com Valor Informado',val: comVal, color: CORES.muted},
    {label: 'Total em Multas',    val: 'R$ ' + totalM.toLocaleString('pt-BR',{minimumFractionDigits:2}), color: CORES.verde},
  ]);

  // ---- POR EMPRESA ----
  sectionTitle('Processos por Empresa', 'üè¢');
  const empMap = {};
  data.forEach(r => { empMap[r.empresa] = (empMap[r.empresa]||0)+1; });
  const empData = Object.entries(empMap).sort((a,b)=>b[1]-a[1]);
  const empCores = {'Rio Novo': CORES.azul, 'Xavante': CORES.roxo, 'Novo Caminho': CORES.verde, 'Tarum√£': CORES.laranja};
  barras(empData.map(([l,v])=>({label:l, val:v, pct:(v/total*100)})), l => empCores[l]||CORES.azul);
  tabela(['Empresa','Qtd','%'], empData.map(([e,v])=>[e, v, (v/total*100).toFixed(1)+'%']), [80,20,20]);

  // ---- POR √ìRG√ÉO ----
  sectionTitle('Processos por √ìrg√£o', '‚öñÔ∏è');
  const orgMap = {};
  data.forEach(r => { orgMap[r.orgao] = (orgMap[r.orgao]||0)+1; });
  const orgData = Object.entries(orgMap).sort((a,b)=>b[1]-a[1]);
  const orgCores = {'AGER': CORES.verde, 'ANTT': CORES.amarelo};
  barras(orgData.map(([l,v])=>({label:l, val:v, pct:(v/total*100)})), l => orgCores[l]||CORES.azul);
  tabela(['√ìrg√£o','Qtd','%'], orgData.map(([o,v])=>[o, v, (v/total*100).toFixed(1)+'%']), [80,20,20]);

  // ---- POR STATUS ----
  sectionTitle('Situa√ß√£o dos Prazos', 'üö¶');
  const stMap = {vencido:0,urgente:0,ok:0,encerrado:0,pendente:0};
  data.forEach(r => { stMap[getStatus(r)]++; });
  const stLabels = {vencido:'Vencido',urgente:'Urgente',ok:'No Prazo',encerrado:'Encerrado',pendente:'Pendente'};
  const stCores = {vencido:CORES.vermelho,urgente:CORES.laranja,ok:CORES.verde,encerrado:CORES.cinza,pendente:CORES.muted};
  const stEntries = Object.entries(stMap).filter(([,v])=>v>0);
  barras(stEntries.map(([k,v])=>({label:stLabels[k], val:v, pct:(v/total*100)})), l => {
    const k = Object.keys(stLabels).find(k=>stLabels[k]===l);
    return stCores[k]||CORES.azul;
  });
  tabela(['Status','Qtd','%'], stEntries.map(([k,v])=>[stLabels[k], v, (v/total*100).toFixed(1)+'%']), [80,20,20]);

  // ---- POR LOCALIDADE ----
  sectionTitle('Processos por Localidade', 'üìç');
  const locMap = {};
  data.forEach(r => { const l=r.local||'N√ÉO INFORMADO'; locMap[l]=(locMap[l]||0)+1; });
  const locData = Object.entries(locMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
  barras(locData.map(([l,v])=>({label:l, val:v, pct:(v/total*100)})));
  tabela(['Localidade','Qtd','%'], locData.map(([l,v])=>[l, v, (v/total*100).toFixed(1)+'%']), [100,15,15]);

  // ---- MULTAS POR EMPRESA ----
  sectionTitle('Total de Multas por Empresa', 'üí∞');
  const multaEmp = {};
  data.filter(r=>r.valor).forEach(r => {
    if(!multaEmp[r.empresa]) multaEmp[r.empresa]={total:0,qtd:0};
    multaEmp[r.empresa].total += parseFloat(r.valor)||0;
    multaEmp[r.empresa].qtd++;
  });
  const multaRows = Object.entries(multaEmp).sort((a,b)=>b[1].total-a[1].total);
  if (multaRows.length) {
    const maxM = multaRows[0][1].total;
    barras(multaRows.map(([e,d])=>({label:e, val:'R$'+d.total.toLocaleString('pt-BR',{minimumFractionDigits:2}), pct:(d.total/maxM*100)})), l=>empCores[l]||CORES.azul);
    tabela(
      ['Empresa','Qtd c/ Valor','Total (R$)','M√©dia (R$)'],
      [...multaRows.map(([e,d])=>[e, d.qtd,
        d.total.toLocaleString('pt-BR',{minimumFractionDigits:2}),
        (d.total/d.qtd).toLocaleString('pt-BR',{minimumFractionDigits:2})
      ]),
      ['TOTAL GERAL', comVal, totalM.toLocaleString('pt-BR',{minimumFractionDigits:2}), '']],
      [55, 25, 40, 40]
    );
  } else {
    doc.setFont('helvetica','italic');
    doc.setFontSize(9);
    doc.setTextColor(...CORES.muted);
    doc.text('Nenhum processo com valor de multa informado.', margin, y);
    y += 8;
  }

  // ---- EVOLU√á√ÉO MENSAL ----
  sectionTitle('Evolu√ß√£o Mensal de Autua√ß√µes', 'üìÖ');
  const mensal = {};
  data.forEach(r => {
    if(!r.data_entrada) return;
    const ym = r.data_entrada.substring(0,7);
    mensal[ym] = (mensal[ym]||0)+1;
  });
  const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const mensalData = Object.entries(mensal).sort((a,b)=>a[0].localeCompare(b[0]));
  const mensalMax = Math.max(...mensalData.map(([,v])=>v),1);
  if (mensalData.length) {
    barras(mensalData.map(([ym,v]) => {
      const [yr,m] = ym.split('-');
      return {label: `${meses[parseInt(m)-1]}/${yr}`, val:v, pct:(v/mensalMax*100)};
    }), () => CORES.roxo);
    tabela(
      ['M√™s/Ano','Quantidade'],
      mensalData.map(([ym,v]) => {
        const [yr,m] = ym.split('-');
        return [`${meses[parseInt(m)-1]}/${yr}`, v];
      }),
      [80, 30]
    );
  }

  // ---- LISTAGEM COMPLETA ----
  novaPage();
  sectionTitle('Listagem Completa dos Processos', 'üìã');
  tabela(
    ['N¬∫','Empresa','√ìrg√£o','Tipo','Assunto','Local','Prazo','Status'],
    data.map(r => [
      r.numero||'‚Äî', r.empresa||'‚Äî', r.orgao||'‚Äî', r.tipo||'‚Äî',
      (r.assunto||'‚Äî').substring(0,30),
      (r.local||'‚Äî').substring(0,20),
      prazoFmt(r),
      SL[getStatus(r)]
    ]),
    [18, 25, 12, 22, 40, 28, 18, 17]
  );

  // Save
  const nome = `relatorio_termos_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(nome);
  toast('‚úÖ PDF gerado e baixado!');
}

// ===== EXPORT CSV =====
function exportarCSV() {
  const data = getRelFiltrados();
  const headers = ['N¬∫','Empresa','√ìrg√£o','Tipo','Assunto','Local','Placa','Data Entrada','Prazo','Status','Valor'];
  const rows = data.map(r => [
    r.numero||'', r.empresa||'', r.orgao||'', r.tipo||'', r.assunto||'',
    r.local||'', r.placa||'', r.data_entrada||'', r.prazo||'',
    SL[getStatus(r)], r.valor||''
  ]);
  const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['Ôªø'+csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `relatorio_termos_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  toast('‚úÖ CSV exportado!');
}

// ===== TOAST =====
function toast(msg){
  let t=document.getElementById('_toast');
  if(!t){
    t=document.createElement('div'); t.id='_toast';
    t.style.cssText='position:fixed;bottom:24px;right:24px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 18px;font-size:13px;font-weight:500;z-index:999;box-shadow:0 8px 32px rgba(0,0,0,.3);transition:all .3s;transform:translateY(20px);opacity:0;';
    document.body.appendChild(t);
  }
  t.textContent=msg;
  setTimeout(()=>{t.style.transform='translateY(0)';t.style.opacity='1';},10);
  setTimeout(()=>{t.style.transform='translateY(20px)';t.style.opacity='0';},3000);
}

// ===== THEME =====
function toggleTheme(){
  const isLight=document.documentElement.classList.toggle('light');
  document.getElementById('theme-icon').textContent=isLight?'‚òÄÔ∏è':'üåô';
  document.getElementById('theme-label').textContent=isLight?'Diurno':'Noturno';
  localStorage.setItem('theme',isLight?'light':'dark');
  if(document.getElementById('page-dashboard').classList.contains('active')) setTimeout(renderDashboard,50);
}

// ===== BADGES =====
function updateBadges(){
  document.getElementById('badge-vencidos').textContent=allRecords.filter(r=>getStatus(r)==='vencido').length;
  document.getElementById('badge-alertas').textContent=allRecords.filter(r=>['vencido','urgente'].includes(getStatus(r))).length;
}

// ===== INIT =====
(function(){
  const saved=localStorage.getItem('theme');
  if(saved==='light'){
    document.documentElement.classList.add('light');
    document.getElementById('theme-icon').textContent='‚òÄÔ∏è';
    document.getElementById('theme-label').textContent='Diurno';
  }
})();
filtered=[...allRecords];
renderDashboard();
updateBadges();
</script>
</body>
</html>
